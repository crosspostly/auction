name: Deploy to Google Apps Script

on:
  push:
    branches:
      - main
    paths:
      - '**.gs'
      - '**.js'
      - 'appsscript.json'
      - '.clasp.json'
  workflow_dispatch:  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üì¶ Install Clasp
        run: |
          npm install -g @google/clasp
          clasp --version

      - name: üîê Validate CLASP_JSON secret
        run: |
          if [ -z "${{ secrets.CLASP_JSON }}" ]; then
            echo "‚ùå ERROR: CLASP_JSON secret is not set!"
            echo "Please add CLASP_JSON to repository secrets."
            exit 1
          fi
          echo "‚úÖ CLASP_JSON secret is set"

      - name: üîë Setup Clasp Authentication
        run: |
          echo "üîë Transforming CLASP_JSON to .clasprc.json format..."
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π JSON –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
          echo '${{ secrets.CLASP_JSON }}' > /tmp/clasp_input.json
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ JSON
          if ! jq empty /tmp/clasp_input.json 2>/dev/null; then
            echo "‚ùå ERROR: CLASP_JSON is not valid JSON!"
            exit 1
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É: –µ—Å—Ç—å –ª–∏ tokens.default?
          HAS_TOKENS_DEFAULT=$(jq -r '.tokens.default // empty' /tmp/clasp_input.json)
          
          if [ ! -z "$HAS_TOKENS_DEFAULT" ]; then
            echo "üìù Detected tokens.default structure, transforming..."
            
            # –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É–µ–º –∏–∑ tokens.default –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç clasp
            jq '{
              token: {
                access_token: .tokens.default.access_token,
                refresh_token: .tokens.default.refresh_token,
                scope: "https://www.googleapis.com/auth/script.projects https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/script.webapp.deploy https://www.googleapis.com/auth/logging.read https://www.googleapis.com/auth/cloud-platform",
                token_type: (.tokens.default.type // "Bearer"),
                expiry_date: 9999999999999
              },
              oauth2ClientSettings: {
                clientId: .tokens.default.client_id,
                clientSecret: .tokens.default.client_secret,
                redirectUri: "http://localhost"
              },
              isLocalCreds: false
            }' /tmp/clasp_input.json > ~/.clasprc.json
            
            echo "‚úÖ Transformed tokens.default to clasp format"
          else
            echo "üìù Standard clasp format detected, using as-is"
            cp /tmp/clasp_input.json ~/.clasprc.json
          fi
          
          echo "‚úÖ Authentication configured"
          
          # üìã –°–æ–∑–¥–∞—ë–º .clasp.json –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
          if [ ! -f ".clasp.json" ]; then
            echo "‚ö†Ô∏è  .clasp.json not found in repository, but that's OK - it exists now"
          fi
          
          echo "üìù Current .clasp.json:"
          cat .clasp.json
          
          echo "üìù Verifying .clasprc.json structure:"
          jq -r '.token.access_token[0:20] + "..."' ~/.clasprc.json
        shell: bash

      - name: üîç Verify files to push
        run: |
          echo "üìÇ Files that will be pushed:"
          ls -la *.gs *.json 2>/dev/null || echo "No .gs or .json files found"
          
          echo ""
          echo "üìÑ appsscript.json content:"
          cat appsscript.json
        shell: bash

      - name: üöÄ Push to Google Apps Script
        id: push
        run: |
          echo "üöÄ Starting push to Google Apps Script..."
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–µ—Ä–µ–¥ push
          echo "üîç Checking clasp status..."
          if ! clasp status; then
            echo "‚ö†Ô∏è  WARNING: clasp status check failed, but continuing..."
          fi
          
          # Push —Å force —á—Ç–æ–±—ã –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å —É–¥–∞–ª–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          echo "üì§ Pushing files..."
          if clasp push --force; then
            echo "‚úÖ Successfully pushed to Google Apps Script!"
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Failed to push to Google Apps Script"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
        shell: bash

      - name: üìä Deployment Summary
        if: always()
        run: |
          echo "## üìä Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit Message**: ${{ github.event.head_commit.message }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Author**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.push.outputs.success }}" = "true" ]; then
            echo "### ‚úÖ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Your changes have been deployed to Google Apps Script." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ùå Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the logs above for error details." >> $GITHUB_STEP_SUMMARY
          fi
        shell: bash

      - name: ‚ùå Deployment Failed Notification
        if: failure()
        run: |
          echo "::error::Deployment to Google Apps Script failed!"
          echo "::error::Check the logs above for details"
          echo "::error::Common issues:"
          echo "::error::1. CLASP_JSON secret is invalid or expired"
          echo "::error::2. .clasp.json missing or has wrong scriptId"
          echo "::error::3. No permission to access the script"
          echo "::error::4. Script with given ID does not exist"
