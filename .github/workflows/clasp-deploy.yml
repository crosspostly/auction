name: Deploy to Google Apps Script

on:
  push:
    branches:
      - main
    paths:
      - '**.gs'
      - '**.js'
      - 'appsscript.json'
      - '.clasp.json'
  workflow_dispatch:  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üì¶ Install Clasp
        run: |
          npm install -g @google/clasp
          clasp --version

      - name: üîê Validate CLASP_JSON secret
        run: |
          if [ -z "${{ secrets.CLASP_JSON }}" ]; then
            echo "‚ùå ERROR: CLASP_JSON secret is not set!"
            echo "Please add CLASP_JSON to repository secrets."
            exit 1
          fi
          echo "‚úÖ CLASP_JSON secret is set"

      - name: üîë Authenticate Clasp
        run: |
          echo "Creating .clasprc.json..."
          echo '${{ secrets.CLASP_JSON }}' > ~/.clasprc.json
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ JSON
          if ! jq empty ~/.clasprc.json 2>/dev/null; then
            echo "‚ùå ERROR: CLASP_JSON is not valid JSON!"
            exit 1
          fi
          
          echo "‚úÖ Authentication configured"
        shell: bash

      - name: üìã Check .clasp.json
        run: |
          if [ ! -f ".clasp.json" ]; then
            echo "‚ö†Ô∏è  WARNING: .clasp.json not found in repository"
            echo "You need to run 'clasp create' or 'clasp clone' locally first"
            echo "Then commit .clasp.json to the repository"
            exit 1
          fi
          
          echo "‚úÖ .clasp.json found"
          echo "Script ID:"
          cat .clasp.json | jq -r '.scriptId'
        shell: bash

      - name: üîç Verify files to push
        run: |
          echo "üìÇ Files that will be pushed:"
          ls -la *.gs *.json 2>/dev/null || echo "No .gs or .json files found"
          
          echo ""
          echo "üìÑ appsscript.json content:"
          cat appsscript.json
        shell: bash

      - name: üöÄ Push to Google Apps Script
        id: push
        run: |
          echo "Starting push to Google Apps Script..."
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–µ—Ä–µ–¥ push
          if ! clasp status; then
            echo "‚ö†Ô∏è  WARNING: clasp status failed, but continuing..."
          fi
          
          # Push —Å force —á—Ç–æ–±—ã –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å —É–¥–∞–ª–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          if clasp push --force; then
            echo "‚úÖ Successfully pushed to Google Apps Script!"
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Failed to push to Google Apps Script"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
        shell: bash

      - name: üìä Deployment Summary
        if: always()
        run: |
          echo "## üìä Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit Message**: ${{ github.event.head_commit.message }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Author**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.push.outputs.success }}" = "true" ]; then
            echo "### ‚úÖ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ùå Deployment Failed" >> $GITHUB_STEP_SUMMARY
          fi
        shell: bash

      - name: ‚ùå Deployment Failed Notification
        if: failure()
        run: |
          echo "::error::Deployment to Google Apps Script failed!"
          echo "::error::Check the logs above for details"
          echo "::error::Common issues:"
          echo "::error::1. CLASP_JSON secret is invalid or expired"
          echo "::error::2. .clasp.json is missing or has wrong scriptId"
          echo "::error::3. No permission to access the script"
