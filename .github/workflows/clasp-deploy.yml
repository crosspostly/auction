name: Deploy to Google Apps Script

on:
  push:
    branches:
      - main
    paths:
      - 'src/**.gs'
      - 'src/**.html'
      - 'src/appsscript.json'
      - 'src/.clasp.json'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üì¶ Install Clasp
        run: |
          npm install -g @google/clasp
          clasp --version

      - name: üîê Validate CLASP_JSON secret
        run: |
          if [ -z "${{ secrets.CLASP_JSON }}" ]; then
            echo "‚ùå ERROR: CLASP_JSON secret is not set!"
            exit 1
          fi
          echo "‚úÖ CLASP_JSON secret is set"

      - name: üîë Setup Clasp Authentication
        run: |
          echo "üîë Transforming CLASP_JSON to .clasprc.json format..."
          
          echo '${{ secrets.CLASP_JSON }}' > /tmp/clasp_input.json
          
          if ! jq empty /tmp/clasp_input.json 2>/dev/null; then
            echo "‚ùå ERROR: CLASP_JSON is not valid JSON!"
            exit 1
          fi
          
          echo "üîç Input structure:"
          jq 'keys' /tmp/clasp_input.json
          
          HAS_TOKENS_DEFAULT=$(jq -r '.tokens.default // empty' /tmp/clasp_input.json)
          
          if [ ! -z "$HAS_TOKENS_DEFAULT" ]; then
            echo "üìù Detected tokens.default structure, transforming..."
            
            jq '{
              token: {
                access_token: .tokens.default.access_token,
                refresh_token: .tokens.default.refresh_token,
                scope: "https://www.googleapis.com/auth/script.projects https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/script.webapp.deploy https://www.googleapis.com/auth/logging.read https://www.googleapis.com/auth/cloud-platform",
                token_type: (.tokens.default.type // "Bearer"),
                expiry_date: 9999999999999
              },
              oauth2ClientSettings: {
                clientId: .tokens.default.client_id,
                clientSecret: .tokens.default.client_secret,
                redirectUri: "http://localhost"
              },
              isLocalCreds: false
            }' /tmp/clasp_input.json > ~/.clasprc.json
            
            echo "‚úÖ Transformed tokens.default to clasp format"
          else
            echo "üìù Standard clasp format detected, using as-is"
            cp /tmp/clasp_input.json ~/.clasprc.json
          fi
          
          echo "‚úÖ Authentication configured"
          
          echo ""
          echo "üîç DEBUG: .clasprc.json structure:"
          jq '{
            has_token: (.token != null),
            has_access_token: (.token.access_token != null),
            has_refresh_token: (.token.refresh_token != null),
            access_token_length: (.token.access_token | length),
            refresh_token_preview: (.token.refresh_token[0:20] + "..."),
            has_oauth2: (.oauth2ClientSettings != null),
            client_id_preview: (.oauth2ClientSettings.clientId[0:20] + "...")
          }' ~/.clasprc.json
        shell: bash

      - name: üîç Verify src directory and .clasp.json
        run: |
          echo "üìÇ Files in src directory:"
          ls -la src/
          
          echo ""
          echo "üìù src/.clasp.json content:"
          cat src/.clasp.json
          
          echo ""
          echo "üìÑ src/appsscript.json content:"
          cat src/appsscript.json
        shell: bash

      - name: üöÄ Push to Google Apps Script
        id: push
        run: |
          cd src
          
          echo "üöÄ Starting push from src directory..."
          echo "Current directory: $(pwd)"
          
          echo "üîç Checking clasp status..."
          if ! clasp status; then
            echo "‚ö†Ô∏è  WARNING: clasp status check failed, but continuing..."
          fi
          
          echo "üì§ Pushing files..."
          if clasp push --force; then
            echo "‚úÖ Successfully pushed to Google Apps Script!"
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Failed to push to Google Apps Script"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
        shell: bash

      - name: üöÄ Deploy new version
        id: deploy
        if: steps.push.outputs.success == 'true'
        run: |
          cd src
          echo "üöÄ Deploying new version..."
          DEPLOYMENT_ID=$(clasp deploy --description "Automated deployment from commit ${{ github.sha }}" | grep -oP '^.*- \K.*' | head -n 1)
          echo "DEPLOYMENT_ID=$DEPLOYMENT_ID" >> $GITHUB_ENV
          echo "‚úÖ New version deployed!"
        shell: bash

      - name: üìä Deployment Summary
        if: always()
        run: |
          echo "## üìä Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit Message**: ${{ github.event.head_commit.message }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Author**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment ID**: ${{ env.DEPLOYMENT_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.push.outputs.success }}" = "true" ]; then
            echo "### ‚úÖ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Your changes have been deployed to Google Apps Script." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ùå Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the logs above for error details." >> $GITHUB_STEP_SUMMARY
          fi
        shell: bash

      - name: ‚ùå Deployment Failed Notification
        if: failure()
        run: |
          echo "::error::Deployment to Google Apps Script failed!"
          echo "::error::Check the logs above for details"
          echo "::error::Common issues:"
          echo "::error::1. CLASP_JSON access token is expired - run 'clasp login' locally and update secret"
          echo "::error::2. src/.clasp.json missing or has wrong scriptId"
          echo "::error::3. No permission to access the script"
          echo "::error::4. Script with given ID does not exist"
