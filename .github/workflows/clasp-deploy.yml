name: Deploy to Google Apps Script

on:
  push:
    branches:
      - main
    paths:
      - '**.gs'
      - '**.js'
      - 'appsscript.json'
      - '.clasp.json'
  workflow_dispatch:  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üì¶ Install Clasp
        run: |
          npm install -g @google/clasp
          clasp --version

      - name: üîê Validate CLASP_JSON secret
        run: |
          if [ -z "${{ secrets.CLASP_JSON }}" ]; then
            echo "‚ùå ERROR: CLASP_JSON secret is not set!"
            echo "Please add CLASP_JSON to repository secrets."
            exit 1
          fi
          echo "‚úÖ CLASP_JSON secret is set"

      - name: üîë Setup Clasp Authentication
        run: |
          echo "üîë Creating .clasprc.json..."
          echo '${{ secrets.CLASP_JSON }}' > ~/.clasprc.json
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ JSON
          if ! jq empty ~/.clasprc.json 2>/dev/null; then
            echo "‚ùå ERROR: CLASP_JSON is not valid JSON!"
            exit 1
          fi
          
          echo "‚úÖ Authentication configured"
          
          # üìã –°–æ–∑–¥–∞—ë–º .clasp.json –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
          if [ ! -f ".clasp.json" ]; then
            echo "üìù .clasp.json not found, extracting scriptId from CLASP_JSON..."
            
            # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å scriptId –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ (CLASP_JSON –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å projects)
            SCRIPT_ID=$(jq -r '.scriptId // empty' ~/.clasprc.json)
            
            if [ -z "$SCRIPT_ID" ]; then
              echo "‚ö†Ô∏è  scriptId not found directly, checking for projects..."
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ projects –≤ CLASP_JSON
              PROJECTS=$(jq -r '.projects // empty' ~/.clasprc.json)
              
              if [ ! -z "$PROJECTS" ]; then
                # –ë–µ—Ä—ë–º –ø–µ—Ä–≤—ã–π –ø—Ä–æ–µ–∫—Ç
                SCRIPT_ID=$(echo "$PROJECTS" | jq -r '.[0].scriptId // empty')
              fi
            fi
            
            if [ -z "$SCRIPT_ID" ]; then
              echo "‚ùå ERROR: Could not extract scriptId from CLASP_JSON!"
              echo "CLASP_JSON should contain either:"
              echo "  1. Top-level 'scriptId' field"
              echo "  2. 'projects' array with scriptId in first element"
              echo ""
              echo "Please run locally:"
              echo "  clasp clone YOUR_SCRIPT_ID"
              echo "Then commit the generated .clasp.json file"
              exit 1
            fi
            
            echo "‚úÖ Found scriptId: $SCRIPT_ID"
            echo "{\"scriptId\":\"$SCRIPT_ID\"}" > .clasp.json
            echo "‚úÖ Created .clasp.json"
          else
            echo "‚úÖ .clasp.json already exists"
          fi
          
          echo "üìù Current .clasp.json:"
          cat .clasp.json
        shell: bash

      - name: üîç Verify files to push
        run: |
          echo "üìÇ Files that will be pushed:"
          ls -la *.gs *.json 2>/dev/null || echo "No .gs or .json files found"
          
          echo ""
          echo "üìÑ appsscript.json content:"
          cat appsscript.json
        shell: bash

      - name: üöÄ Push to Google Apps Script
        id: push
        run: |
          echo "üöÄ Starting push to Google Apps Script..."
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–µ—Ä–µ–¥ push
          echo "üîç Checking clasp status..."
          if ! clasp status; then
            echo "‚ö†Ô∏è  WARNING: clasp status check failed, but continuing..."
          fi
          
          # Push —Å force —á—Ç–æ–±—ã –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å —É–¥–∞–ª–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          echo "üì§ Pushing files..."
          if clasp push --force; then
            echo "‚úÖ Successfully pushed to Google Apps Script!"
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Failed to push to Google Apps Script"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
        shell: bash

      - name: üìä Deployment Summary
        if: always()
        run: |
          echo "## üìä Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit Message**: ${{ github.event.head_commit.message }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Author**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.push.outputs.success }}" = "true" ]; then
            echo "### ‚úÖ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Your changes have been deployed to Google Apps Script." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ùå Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the logs above for error details." >> $GITHUB_STEP_SUMMARY
          fi
        shell: bash

      - name: ‚ùå Deployment Failed Notification
        if: failure()
        run: |
          echo "::error::Deployment to Google Apps Script failed!"
          echo "::error::Check the logs above for details"
          echo "::error::Common issues:"
          echo "::error::1. CLASP_JSON secret is invalid or expired"
          echo "::error::2. scriptId not found in CLASP_JSON"
          echo "::error::3. No permission to access the script"
          echo "::error::4. Script with given ID does not exist"
