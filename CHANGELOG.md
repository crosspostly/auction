# Changelog

Все значимые изменения в проекте "VK Аукционный Бот" будут задокументированы в этом файле.

## [2.0.0] - 2026-02-11

### Добавлено
- **Новая архитектура данных**: Внедрена новая модель данных с листами `Пользователи` и `Заказы` вместо `Победители`. Это позволяет вести историю по каждому пользователю и реализовывать механику "накопления" лотов.
- **Автоматический диалог с пользователем**: Реализован обработчик `handleMessageNew`, который по кодовому слову (`CODE_WORD` из настроек) отправляет пользователю в ЛС сводку по его неоплаченным лотам, рассчитывает стоимость доставки и предоставляет реквизиты для оплаты.
- **Парсинг изображений из постов**: Функция `parseLotFromPost` теперь извлекает URL изображения и ID вложения из поста с лотом, сохраняя их в лист "Лоты".
- **Ссылки на посты в отчете для администраторов**: Функция `sendAdminReport` была переработана. Вместо прикрепления одной картинки, она теперь добавляет в текстовый отчет прямые ссылки на посты с каждым выигранным лотом.

### Изменено
- **Конфигурация `CODE_WORD`**: Кодовое слово для вызова сводки в ЛС теперь настраивается в листе "Настройки".
- **Функция `finalizeAuction`**: Полностью переписана для работы с новой архитектурой данных (`Пользователи` и `Заказы`).
- **Константа `SHEETS`**: Обновлена для отражения новой структуры листов.

### Удалено
- **Лист `Победители`**: Старая таблица с победителями удалена в пользу новой системы `Пользователи` + `Заказы`.
- **Избыточные файлы тестов**: `Tests.gs`, `AdditionalTests.gs`, `TestComponents.gs` были объединены в один файл `IntegrationTests.gs`.

### Исправлено
- **Стабильность запуска бота**: Устранена причина постоянных перезапусков бота (`telegram_bot_standalone`) путем создания необходимого виртуального окружения `venv`.

## [Не выпущенная версия] - 2026-02-11

### Добавлено
- **Симулятор аукциона**: Добавлен `AuctionSimulator.gs` для создания тестовых постов и комментариев в VK.
- **Меню управления симулятором**: В меню "СИМУЛЯТОР" добавлены опции для запуска, остановки и настройки симулятора.
- **Система мониторинга**: Создан скрипт `Monitoring.gs` и лист "Статистика" для записи всех системных событий.
- **Документация**: Описаны новые функции симулятора и мониторинга.

### Изменено
- **`Code.gs`**: Добавлено меню "СИМУЛЯТОР" в функцию `onOpen`.
- **`Sheets.gs`**: Добавлен лист "Статистика" в список листов.

## [Не выпущенная версия] - 2026-02-11

### Добавлено
- **Раскрывающиеся списки для переключателей**: Добавлена функция `applyDropdownValidation()` в `Sheets.gs` для автоматического создания выпадающих списков "ВКЛ"/"ВЫКЛ" в листе "Настройки".
- **Новая структура листа настроек**: Переработана функция `createDemoData()` в `Sheets.gs` для логичной группировки настроек по разделам: "--- АДМИНИСТРАТОР ---", "--- ОСНОВНЫЕ ПАРАМЕТРЫ ---", "--- ПЕРЕКЛЮЧАТЕЛИ ---", "--- ШАБЛОНЫ ---".

### Изменено
- **Безопасное хранение реквизитов**: `payment_phone` и `payment_bank` теперь хранятся только в свойствах скрипта (PropertiesService) и подставляются в шаблон `order_summary_template` функцией `buildWinnerMessage()` в `Code.gs` в момент формирования сообщения. Удалены из листа "Настройки".
- **Обновлена логика чтения настроек**: Функции `getSetting()`, `logDebug()`, `validateBid()`, `enhancedValidateBid()` в `Code.gs` адаптированы для работы с новой структурой настроек и toggle-переключателями.
- **`setupDefaultSettings` удалена**: Функции `setupDefaultSettings()` удалена из `Code.gs` как избыточная, все настройки теперь управляются через `createDemoData()` в `Sheets.gs`.
- **`runSetupWizard` обновлен**: Теперь вызывает `createDemoData()` для создания всех настроек.

### Удалено
- **Избыточные настройки**: `DEBUG_VK_API` и `require_subscription` удалены из дефолтных настроек и их описаний в `Code.gs`, поскольку они теперь управляются через `TOGGLE_SETTINGS` или `PropertiesService`.

## [Не выпущенная версия] - 2026-02-11

### Добавлено
- **Мастер подключения (4 шага)**: Полностью автоматизированный процесс настройки бота прямо из таблицы.
- **Двухтокенная архитектура**: Разделение на Admin Token (для настроек) и Group Token (для работы бота), что повышает надежность и обходит ограничения VK.
- **Тихая проверка прав**: Автоматический тест на Шаге 4, который создает и мгновенно удаляет проверочный пост/комментарий.
- **Умный парсинг токенов**: Поля ввода теперь сами извлекают `access_token` из полной ссылки в адресной строке.
- **Поддержка ссылок на группы**: В Шаге 1 можно вводить как цифровой ID, так и полную ссылку на группу.
- **Индикация статуса**: Визуальное отображение сохраненных данных в интерфейсе настроек.
- **Детальная диагностика**: Новые пункты меню для проверки прав и идентификации владельцев токенов.

### Изменено
- **Логирование ошибок**: Теперь ошибки VK API записываются с понятным текстовым описанием вместо технических объектов.
- **Автоматизация Callback**: Скрипт сам получает код подтверждения и настраивает сервер через Admin Token.

## [Не выпущенная версия] - 2026-02-10

### Добавлено
- **Улучшенная обработка ошибок VK API**: Реализован экспоненциальный ретрай для всех вызовов VK API с обработкой наиболее распространенных ошибок (лимиты, временные сбои)
- **Обработка событий редактирования и удаления комментариев**: Добавлены обработчики для `wall_reply_edit` и `wall_reply_delete`, с логикой обновления/удаления соответствующих ставок в системе
- **Проверка подписки на группу**: Добавлена возможность требовать подписку для участия в аукционе через настройку `require_subscription`
- **Улучшенная обработка ошибок отправки сообщений**: Добавлена проверка ошибок при отправке сообщений пользователям и обработка ситуаций, когда пользователь заблокировал сообщения от сообщества
- **Новый тип уведомлений**: Добавлен тип `subscription_required` для уведомления пользователей о необходимости подписки
- **Расширенная валидация ставок**: Интегрирована проверка подписки в процесс валидации ставок
- **Расширенные возможности мониторинга**: Добавлены события для отслеживания новых сценариев и обработки редактирования/удаления комментариев
- **Новые функции тестирования**: Добавлены модульные и интеграционные тесты для проверки полного цикла аукциона
- **Система мониторинга и автоматического восстановления**: Комплексные механизмы мониторинга, проверки здоровья системы и автоматического восстановления
- **Обновленная документация**: Обновлены README и инструкции с описанием всех новых возможностей

### Изменено
- **Версия API**: Обновлена версия VK API до 5.199 во всех вызовах
- **Улучшенное логирование**: Добавлены детализированные логи ошибок с указанием количества попыток для ретраев
- **Расширенные шаблоны сообщений**: Добавлены дружелюбные сообщения для всех сценариев, включая необходимость подписки
- **Обновлены настройки по умолчанию**: Добавлена настройка `require_subscription` со значением по умолчанию `false`

### Исправлено
- **Проблема с обработкой новых лотов**: Исправлены недостающие функции `enqueueEvent` и `processEventQueue`, которые мешали обработке новых лотов
- **Отправка уведомлений о низких ставках**: Улучшена логика отправки уведомлений пользователям, чьи ставки оказались ниже текущей
- **Обработка застрявших уведомлений**: Улучшена обработка ситуаций, когда уведомления застревают в очереди

## [1.0.0] - 2025-12-XX

### Добавлено
- **Базовая функциональность аукциона**: Автоматическое обнаружение постов-лотов, обработка ставок, определение победителей
- **Интеграция с VK API**: Callback API для получения событий, отправка сообщений и комментариев
- **Хранение данных**: Использование Google Sheets для хранения лотов, ставок, победителей и настроек
- **Симулятор аукциона**: Инструмент для тестирования и генерации тестовых данных
- **Система уведомлений**: Отправка уведомлений о перебитых ставках и победителях