# Auction Simulator & Monitoring Feature

## Summary

Implemented a comprehensive auction simulator and an independent event monitoring system to allow for robust, real-world testing and statistical analysis of the VK Auction Bot.

## Changes

### 1. Independent Monitoring System

- **`Sheets.gs`**: Added a new sheet definition for `Статистика` (`Statistics`). This sheet will store all key auction events for analysis.
- **`Monitoring.gs`**: Created a new, independent script file.
  - Contains a single function `Monitoring.recordEvent(eventType, data)` which is its sole responsibility to write events to the `Статистика` sheet.
  - This ensures that monitoring is decoupled from the main application logic.

### 2. Monitoring Integration

- **`Code.gs`**: Integrated calls to `Monitoring.recordEvent` at all critical points in the auction lifecycle:
  - `LOT_CREATED`: When a new lot is parsed from a VK post.
  - `LOT_PARSE_FAILED`: If a post with the `#аукцион` hashtag cannot be parsed.
  - `BID_RECEIVED`: When any new comment is received on a lot post.
  - `BID_VALIDATED`: After a bid is checked for validity, logs the outcome (success or failure with reason).
  - `LEADER_UPDATED`: When a valid bid makes a user the new leader.
  - `OUTBID_NOTIFICATION_QUEUED`: When a notification is queued for an outbid user.
  - `AUCTION_FINALIZATION_STARTED`: When the `finalizeAuction` process begins.
  - `WINNER_DECLARED`: When a lot is successfully sold to a winner.
  - `LOT_UNSOLD`: When a lot ends with no bids.
- The `validateBid` function was improved to return a detailed object with a reason for failure, which is now logged.

### 3. Auction Simulator

- **`AuctionSimulator.gs`**: Created a new script file to house all simulation logic.
  - **`runSingleSimulation()`**: The core function that simulates one full auction cycle:
    - Publishes a **real post** to the VK group wall with a unique test lot ID.
    - Publishes 10-30 **real comments** under the post using a provided user token, simulating various bidding scenarios.
  - **Bidding Scenarios Implemented**:
    - **Valid Bids**: Standard incremental bids.
    - **High Frequency**: Multiple bids sent with very short delays to test concurrency handling.
    - **Same Bid**: Bidding the current price.
    - **Lower Bid**: Bidding below the current price.
    - **Invalid Step**: Bidding an amount that is not a multiple of the required step.
  - **Simulation Controls**:
    - `setupHourlySimulation()`: Sets up a time-based trigger to run the simulation once per hour.
    - `stopSimulation()`: Deletes the trigger to halt the simulation.
    - `resetSimulationCounter()`: Resets the post counter (max 5 posts per full simulation run).
- **`VkApi.gs`**: The `callVk` function was slightly modified to optionally accept a user token, allowing the simulator to post comments on behalf of a user.

### 4. User Interface

- **`Code.gs`**: Added a new "СИМУЛЯТОР" sub-menu to the main `VK Auction` menu in the spreadsheet, providing easy access to:
  - Run one simulation cycle manually.
  - Enable/disable the hourly simulation.
  - Reset the post counter.

## How to Use

1.  Open the Google Sheet.
2.  Use the **VK Auction > СИМУЛЯТОР** menu to control the simulation.
3.  Observe new posts and comments appearing in the VK group.
4.  View the `Статистика` sheet to see a real-time log of all events generated by the simulation.