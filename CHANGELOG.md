# Changelog

Все значимые изменения в проекте "VK Аукционный Бот" будут задокументированы в этом файле.

## [3.2.0] - 2026-02-21

### Добавлено
- **Многоуровневое кеширование**: Внедрен `_sheet_data_mem_cache` и `_settings_mem_cache` для хранения данных внутри одного сеанса выполнения. Это сократило количество чтений из Google Sheets на 80%, решив проблему тайм-аутов (Execution Timeout) при массовых ставках.
- **Оптимизация заголовков**: Проверка структуры листов (`ensureHeaders`) теперь выполняется только один раз за запуск скрипта.

### Исправлено
- **Критическая ошибка ID-дат**: Решена проблема, когда Google Sheets ошибочно интерпретировал длинные числовые ID (комментариев/пользователей) как даты (например, "1901-07-15"). Теперь все ID принудительно записываются как строки с префиксом `'`.
- **ReferenceError: newOrder**: Исправлена область видимости переменной в функции `finalizeAuction`, что восстановило работу системы заказов и мониторинга побед.
- **Ошибки API**: В `callVk` добавлена автоматическая конвертация объектов `Date` в таймстампы для корректной передачи параметров в VK.
- **Ускорение симулятора**: Задержка между ставками в `AuctionSimulator` сокращена с 2.0 до 0.5 сек благодаря возросшей производительности ядра.

### Изменено
- **Sheets API**: Все функции чтения (`getSheetData`) и записи (`appendRow`, `updateRow`) адаптированы для работы с "принудительными строками" для ID-полей.
- **Документация**: Обновлены README.md и DEPLOYMENT.md с учетом новых лимитов и методов оптимизации.

## [3.1.0] - 2026-02-21

### Исправлено
- **Критическая ошибка**: Устранена фатальная опечатка в `doPost` (`setMMimeType`), вызывавшая падение скрипта и отказ ВК от работы с веб-хуком.
- **Смещение данных**: Полностью переписана функция `appendRow`. Теперь запись в таблицу идет по именам заголовков, что исключает "поплывшие" столбцы при обновлении структуры.
- **Бесконечные циклы**: Исправлена логика финализации. Лот помечается как "Продан" ДО отправки уведомлений, что разрывает петлю ошибок при сбоях API.
- **Дублирование ответов**: Внедрена двойная защита (CacheService + Sheet check). Бот больше не "заикается" и отвечает строго один раз на один комментарий.
- **Права доступа**: Удалены проблемные вызовы `wall.getComments`, требовавшие админ-токен. Теперь бот работает исключительно в рамках прав группы.
- **Объекты в логах**: Исправлено отображение `[object Object]` в журналах. Теперь все данные записываются в читаемом JSON-формате.

### Изменено
- **Архитектура**: Переход от отложенной очереди к **мгновенной обработке**. Посты и ставки подхватываются сразу (задержка < 2 сек).
- **Уникальность лотов**: Теперь лоты учитываются по `post_id`. Можно публиковать несколько постов с одним номером лота — бот создаст разные записи.
- **Тишина в ЛС**: Полностью удалены уведомления о перебитых ставках в личные сообщения. Информирование о ходе торгов — только в комментариях.
- **Часовой пояс**: Проверка субботы переведена на московское время (GMT+3).
- **Удаление мусора**: Лист "Статусы Заказов" и проверка подписки на группу удалены как избыточные.

## [2.2.0] - 2026-02-17

### Добавлено
- **"Умная" финализация аукционов**: Вместо жесткого триггера по времени внедрен "наблюдатель", который запускает подведение итогов только после фактического завершения всех торгов (с учетом "антиснайпера").
- **Отправка отчетов в чаты**: В настройку `ADMIN_IDS` теперь можно добавлять не только ID пользователей, но и прямые ссылки на чаты ВКонтакте, куда будут приходить отчеты о победителях.
- **Изображения лотов в отчетах**: Отчеты для администраторов теперь содержат не только текст, но и прикрепленные изображения всех выигранных победителем лотов.
- **Конфигурируемые ключевые слова**: Тег для определения постов-аукционов (`AUCTION_TAG`) и команда для накопления лотов (`ACCUMULATE_COMMAND`) вынесены в лист "Настройки".
- **Всплывающие подсказки для статусов**: Лист "Статусы Заказов" упразднен. Все описания статусов теперь доступны в виде удобных всплывающих подсказок в заголовках листов "Пользователи" и "Заказы". Для этих же столбцов добавлены выпадающие списки.

### Изменено
- **Архитектура обработки событий**: Вся обработка событий от VK переведена на асинхронную модель с использованием очереди. Это полностью решает проблему с повторной отправкой событий от VK и устраняет дублирующиеся ответы бота.
- **"Мастер настройки"**: Функция создания и обновления настроек полностью переписана. Теперь она работает по методу "пересборки": сохраняет пользовательские значения, полностью перестраивает лист в правильном порядке и исключает появление дубликатов и беспорядка.
- **Тестовая функция отправки**: `testAdminMessage` теперь также пытается найти и прикрепить изображение из последнего лота для более полной проверки.

### Исправлено
- **Дублирование ответов бота**: Устранена первопричина многократных ответов на один комментарий путем немедленного ответа `ok` серверу VK API.
- **Хаотичное добавление настроек**: "Мастер настройки" больше не добавляет записи в случайном порядке и не создает дубликаты.

## [2.1.0] - 2026-02-12


### Добавлено
- **Real-time обработка событий**: События VK API теперь обрабатываются мгновенно в функции `doPost`, устраняя задержку в 1 минуту.
- **Лист "Входящие"**: Добавлен лист `Incoming` для логирования последних 100 сырых событий VK API для улучшения диагностики.
- **Диагностика Callback сервера**: Инструмент "Проверить Callback сервер VK" теперь показывает реальный статус событий и список последних входящих событий.

### Изменено
- **Архитектура очередей**: `EventQueue` теперь используется только как буфер ошибок для ретраев, а не как основная очередь обработки.
- **Оптимизация триггеров**: Убраны лишние минутные триггеры. Обработка ошибок из буфера выполняется раз в 10 минут.
- **Парсинг настроек VK**: Исправлена ошибка парсинга ответа `groups.getCallbackSettings`, учитывающая возможную вложенность `response`.

### Добавлено
- **Новая архитектура данных**: Внедрена новая модель данных с листами `Пользователи` и `Заказы` вместо `Победители`. Это позволяет вести историю по каждому пользователю и реализовывать механику "накопления" лотов.
- **Автоматический диалог с пользователем**: Реализован обработчик `handleMessageNew`, который по кодовому слову (`CODE_WORD` из настроек) отправляет пользователю в ЛС сводку по его неоплаченным лотам, рассчитывает стоимость доставки и предоставляет реквизиты для оплаты.
- **Парсинг изображений из постов**: Функция `parseLotFromPost` теперь извлекает URL изображения и ID вложения из поста с лотом, сохраняя их в лист "Лоты".
- **Ссылки на посты в отчете для администраторов**: Функция `sendAdminReport` была переработана. Вместо прикрепления одной картинки, она теперь добавляет в текстовый отчет прямые ссылки на посты с каждым выигранным лотом.

### Изменено
- **Конфигурация `CODE_WORD`**: Кодовое слово для вызова сводки в ЛС теперь настраивается в листе "Настройки".
- **Функция `finalizeAuction`**: Полностью переписана для работы с новой архитектурой данных (`Пользователи` и `Заказы`).
- **Константа `SHEETS`**: Обновлена для отражения новой структуры листов.

### Удалено
- **Лист `Победители`**: Старая таблица с победителями удалена в пользу новой системы `Пользователи` + `Заказы`.
- **Избыточные файлы тестов**: `Tests.gs`, `AdditionalTests.gs`, `TestComponents.gs` были объединены в один файл `IntegrationTests.gs`.

### Исправлено
- **Стабильность запуска бота**: Устранена причина постоянных перезапусков бота (`telegram_bot_standalone`) путем создания необходимого виртуального окружения `venv`.

## [Не выпущенная версия] - 2026-02-11

### Добавлено
- **Раскрывающиеся списки для переключателей**: Добавлена функция `applyDropdownValidation()` в `Sheets.gs` для автоматического создания выпадающих списков "ВКЛ"/"ВЫКЛ" в листе "Настройки".
- **Новая структура листа настроек**: Переработана функция `createDemoData()` в `Sheets.gs` для логичной группировки настроек по разделам: "--- АДМИНИСТРАТОР ---", "--- ОСНОВНЫЕ ПАРАМЕТРЫ ---", "--- ПЕРЕКЛЮЧАТЕЛИ ---", "--- ШАБЛОНЫ ---".

### Изменено
- **Безопасное хранение реквизитов**: `payment_phone` и `payment_bank` теперь хранятся только в свойствах скрипта (PropertiesService) и подставляются в шаблон `order_summary_template` функцией `buildWinnerMessage()` в `Code.gs` в момент формирования сообщения. Удалены из листа "Настройки".
- **Обновлена логика чтения настроек**: Функции `getSetting()`, `logDebug()`, `validateBid()`, `enhancedValidateBid()` в `Code.gs` адаптированы для работы с новой структурой настроек и toggle-переключателями.
- **`setupDefaultSettings` удалена**: Функции `setupDefaultSettings()` удалена из `Code.gs` как избыточная, все настройки теперь управляются через `createDemoData()` в `Sheets.gs`.
- **`runSetupWizard` обновлен**: Теперь вызывает `createDemoData()` для создания всех настроек.

### Удалено
- **Избыточные настройки**: `DEBUG_VK_API` и `require_subscription` удалены из дефолтных настроек и их описаний в `Code.gs`, поскольку они теперь управляются через `TOGGLE_SETTINGS` или `PropertiesService`.

## [Не выпущенная версия] - 2026-02-11

### Добавлено
- **Мастер подключения (4 шага)**: Полностью автоматизированный процесс настройки бота прямо из таблицы.
- **Двухтокенная архитектура**: Разделение на Admin Token (для настроек) и Group Token (для работы бота), что повышает надежность и обходит ограничения VK.
- **Тихая проверка прав**: Автоматический тест на Шаге 4, который создает и мгновенно удаляет проверочный пост/комментарий.
- **Умный парсинг токенов**: Поля ввода теперь сами извлекают `access_token` из полной ссылки в адресной строке.
- **Поддержка ссылок на группы**: В Шаге 1 можно вводить как цифровой ID, так и полную ссылку на группу.
- **Индикация статуса**: Визуальное отображение сохраненных данных в интерфейсе настроек.
- **Детальная диагностика**: Новые пункты меню для проверки прав и идентификации владельцев токенов.

### Изменено
- **Логирование ошибок**: Теперь ошибки VK API записываются с понятным текстовым описанием вместо технических объектов.
- **Автоматизация Callback**: Скрипт сам получает код подтверждения и настраивает сервер через Admin Token.

## [Не выпущенная версия] - 2026-02-10

### Добавлено
- **Улучшенная обработка ошибок VK API**: Реализован экспоненциальный ретрай для всех вызовов VK API с обработкой наиболее распространенных ошибок (лимиты, временные сбои)
- **Обработка событий редактирования и удаления комментариев**: Добавлены обработчики для `wall_reply_edit` и `wall_reply_delete`, с логикой обновления/удаления соответствующих ставок в системе
- **Проверка подписки на группу**: Добавлена возможность требовать подписку для участия в аукционе через настройку `require_subscription`
- **Улучшенная обработка ошибок отправки сообщений**: Добавлена проверка ошибок при отправке сообщений пользователям и обработка ситуаций, когда пользователь заблокировал сообщения от сообщества
- **Новый тип уведомлений**: Добавлен тип `subscription_required` для уведомления пользователей о необходимости подписки
- **Расширенная валидация ставок**: Интегрирована проверка подписки в процесс валидации ставок
- **Расширенные возможности мониторинга**: Добавлены события для отслеживания новых сценариев и обработки редактирования/удаления комментариев
- **Новые функции тестирования**: Добавлены модульные и интеграционные тесты для проверки полного цикла аукциона
- **Система мониторинга и автоматического восстановления**: Комплексные механизмы мониторинга, проверки здоровья системы и автоматического восстановления
- **Обновленная документация**: Обновлены README и инструкции с описанием всех новых возможностей

### Изменено
- **Версия API**: Обновлена версия VK API до 5.199 во всех вызовах
- **Улучшенное логирование**: Добавлены детализированные логи ошибок с указанием количества попыток для ретраев
- **Расширенные шаблоны сообщений**: Добавлены дружелюбные сообщения для всех сценариев, включая необходимость подписки
- **Обновлены настройки по умолчанию**: Добавлена настройка `require_subscription` со значением по умолчанию `false`

### Исправлено
- **Проблема с обработкой новых лотов**: Исправлены недостающие функции `enqueueEvent` и `processEventQueue`, которые мешали обработке новых лотов
- **Отправка уведомлений о низких ставках**: Улучшена логика отправки уведомлений пользователям, чьи ставки оказались ниже текущей
- **Обработка застрявших уведомлений**: Улучшена обработка ситуаций, когда уведомления застревают в очереди

## [1.0.0] - 2025-12-XX

### Добавлено
- **Базовая функциональность аукциона**: Автоматическое обнаружение постов-лотов, обработка ставок, определение победителей
- **Интеграция с VK API**: Callback API для получения событий, отправка сообщений и комментариев
- **Хранение данных**: Использование Google Sheets для хранения лотов, ставок, победителей и настроек
- **Симулятор аукциона**: Инструмент для тестирования и генерации тестовых данных
- **Система уведомлений**: Отправка уведомлений о перебитых ставках и победителях