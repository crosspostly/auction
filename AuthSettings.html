<!DOCTYPE html>
<html>
  <head>
    <base target="_blank">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Roboto', sans-serif;
        padding: 15px;
        color: #333;
        font-size: 13px;
      }
      .form-group {
        margin-bottom: 12px;
      }
      label {
        display: block;
        margin-bottom: 4px;
        font-weight: 500;
        color: #555;
      }
      input[type="text"], input[type="password"] {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
      }
      .input-wrapper {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .hint {
        font-size: 11px;
        color: #888;
        margin-top: 2px;
      }
      button {
        background-color: #1976d2;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
      }
      button.secondary {
        background-color: #eee;
        color: #333;
        border: 1px solid #ddd;
        padding: 6px 10px;
        font-size: 12px;
        white-space: nowrap;
      }
      button.secondary:hover {
        background-color: #e0e0e0;
      }
      button.action {
        background-color: #4caf50;
        width: 100%;
        margin-top: 5px;
        padding: 10px;
        font-weight: bold;
      }
      button.action:hover {
        background-color: #388e3c;
      }
      button.submit {
        width: 100%;
        margin-top: 15px;
        padding: 10px;
        font-size: 14px;
        background-color: #1976d2;
      }
      button.submit:hover {
        background-color: #1565c0;
      }
      .status {
        margin-top: 10px;
        font-size: 12px;
        text-align: center;
        min-height: 20px;
        white-space: pre-wrap;
      }
      .section-title {
        color: #1976d2;
        font-weight: 700;
        margin-top: 15px;
        margin-bottom: 8px;
        border-bottom: 1px dashed #ddd;
        padding-bottom: 4px;
        font-size: 14px;
      }
      h3 { margin-top: 0; font-size: 16px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
    </style>
  </head>
  <body>
    <h3>üîê –ú–∞—Å—Ç–µ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –±–æ—Ç–∞ (4 —à–∞–≥–∞)</h3>
    <form id="authForm" onsubmit="return false;">
      
      <div class="section-title">üì° –®–∞–≥ 1: –ì—Ä—É–ø–ø–∞ –∏ –°–µ—Ä–≤–µ—Ä</div>
      <div class="form-group">
        <label>ID –∏–ª–∏ –°—Å—ã–ª–∫–∞ –Ω–∞ –≥—Ä—É–ø–ø—É</label>
        <div class="input-wrapper">
          <input type="text" id="group_id" name="group_id" placeholder="vk.com/club123 –∏–ª–∏ 123456">
        </div>
        <div class="hint" id="hint_group_id">–¢–µ–∫—É—â–∏–π ID: (–Ω–µ –∑–∞–¥–∞–Ω)</div>
      </div>

      <div class="form-group">
        <label>URL –í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–∏–∑ Deploy)</label>
        <div class="input-wrapper">
          <input type="text" id="web_app_url" name="web_app_url" placeholder="https://script.google.com/macros/s/...">
        </div>
        <div class="hint" id="hint_web_app_url">–¢–µ–∫—É—â–∏–π URL: (–Ω–µ –∑–∞–¥–∞–Ω)</div>
      </div>

      <div class="section-title">üîë –®–∞–≥ 2: Admin Token (–¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫)</div>
      <div class="form-group" style="text-align: center;">
        <a id="user_token_link" href="https://oauth.vk.com/authorize?client_id=2685278&scope=335872&redirect_uri=https://oauth.vk.com/blank.html&display=page&response_type=token&revoke=1" 
           target="_blank" 
           style="display: block; background-color: #2196f3; color: white; text-decoration: none; text-align: center; padding: 10px; border-radius: 4px; font-weight: bold; font-size: 13px;">
           üîó –ü–û–õ–£–ß–ò–¢–¨ ADMIN TOKEN
        </a>
      </div>
      <div class="form-group">
        <input type="password" id="user_token" name="user_token" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É —Å USER —Ç–æ–∫–µ–Ω–æ–º —Å—é–¥–∞...">
        <div class="hint" id="hint_user_token">–¢–æ–∫–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: (–Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω)</div>
      </div>

      <div class="section-title">üè¢ –®–∞–≥ 3: Group Token (–¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤)</div>
      <div class="form-group" style="text-align: center;">
        <a id="vk_token_link" href="https://oauth.vk.com/authorize?client_id=2685278&scope=274432&redirect_uri=https://oauth.vk.com/blank.html&display=page&response_type=token" 
           target="_blank" 
           style="display: block; background-color: #ff9800; color: white; text-decoration: none; text-align: center; padding: 10px; border-radius: 4px; font-weight: bold; font-size: 13px;">
           üîó –ü–û–õ–£–ß–ò–¢–¨ GROUP TOKEN
        </a>
      </div>
      <div class="form-group">
        <input type="password" id="vk_token" name="vk_token" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É —Å GROUP —Ç–æ–∫–µ–Ω–æ–º —Å—é–¥–∞...">
        <div class="hint" id="hint_vk_token">–¢–æ–∫–µ–Ω –≥—Ä—É–ø–ø—ã: (–Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω)</div>
      </div>

      <div class="form-group" style="margin-top: 20px;">
        <button type="button" class="action" onclick="autoConnect()">üöÄ –®–ê–ì 4: –ü–û–î–ö–õ–Æ–ß–ò–¢–¨ –ò –ü–†–û–í–ï–†–ò–¢–¨</button>
        <div class="hint" style="text-align: center;">–ù–∞—Å—Ç—Ä–æ–∏—Ç Callback –∏ —Å–¥–µ–ª–∞–µ—Ç —Ç–∏—Ö—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∞–≤.</div>
      </div>

      <div class="section-title">üí≥ –†–µ–∫–≤–∏–∑–∏—Ç—ã –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</div>

      <div class="form-group">
        <label>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–°–ë–ü)</label>
        <input type="text" id="payment_phone" name="payment_phone" placeholder="+79000000000">
        <div class="hint" id="hint_payment_phone">–¢–µ–∫—É—â–∏–π: (–Ω–µ –∑–∞–¥–∞–Ω)</div>
      </div>

      <div class="form-group">
        <label>–ë–∞–Ω–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª—è</label>
        <input type="text" id="payment_bank" name="payment_bank" placeholder="–°–±–µ—Ä–±–∞–Ω–∫...">
        <div class="hint" id="hint_payment_bank">–¢–µ–∫—É—â–∏–π: (–Ω–µ –∑–∞–¥–∞–Ω)</div>
      </div>
      
      <div class="form-group">
        <label>–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</label>
        <input type="password" name="admin_password" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –Ω–µ –º–µ–Ω—è–µ—Ç–µ">
      </div>

      <button type="button" class="submit" onclick="handleFormSubmit()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</button>
    </form>
    
    <div id="status" class="status"></div>

    <script>
      google.script.run.withSuccessHandler(populateForm).getPublicAuthSettings();

      // –£–º–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ –¥–ª—è –æ–±–æ–∏—Ö –ø–æ–ª–µ–π —Ç–æ–∫–µ–Ω–æ–≤
      [document.getElementById('user_token'), document.getElementById('vk_token')].forEach(el => {
        el.addEventListener('paste', function(e) {
          setTimeout(() => {
            const text = this.value;
            // –†–µ–≥—É–ª—è—Ä–∫–∞ —Ç–µ–ø–µ—Ä—å –ª–æ–≤–∏—Ç –∏ –æ–±—ã—á–Ω—ã–π access_token, –∏ –≥—Ä—É–ø–ø–æ–≤–æ–π access_token_12345
            const match = text.match(/access_token(?:_\d+)?=([a-zA-Z0-9\.\-_]+)/);
            if (match) {
              this.value = match[1];
              flashField(this);
            }
          }, 100);
        });
      });

      // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Å—ã–ª–æ–∫
      function updateLinks() {
        const gidInput = document.getElementById('group_id').value;
        const gidMatch = gidInput.match(/\d+/);
        const gid = gidMatch ? gidMatch[0] : "";
        
        const baseUrlGroup = 'https://oauth.vk.com/authorize?client_id=2685278&scope=274432&redirect_uri=https://oauth.vk.com/blank.html&display=page&response_type=token';
        const groupLink = document.getElementById('vk_token_link');
        groupLink.href = gid ? `${baseUrlGroup}&group_ids=${gid}` : baseUrlGroup;
      }

      document.getElementById('group_id').addEventListener('input', updateLinks);

      function autoConnect() {
        const status = document.getElementById('status');
        const btn = document.querySelector('button.action');

        btn.disabled = true;
        btn.textContent = '‚è≥ –í—ã–ø–æ–ª–Ω—è—é 4 —à–∞–≥–∞...';
        status.textContent = '‚è≥ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é —Å–µ—Ä–≤–µ—Ä –∏ –ø—Ä–æ–≤–µ—Ä—è—é –ø—Ä–∞–≤–∞ –≥—Ä—É–ø–ø—ã...';
        status.style.color = '#1976d2';
        
        const formData = {
          group_id: document.getElementById('group_id').value,
          web_app_url: document.getElementById('web_app_url').value,
          user_token: document.getElementById('user_token').value,
          vk_token: document.getElementById('vk_token').value,
        };

        google.script.run
          .withSuccessHandler((res) => {
             btn.disabled = false;
             btn.textContent = 'üöÄ –ü–û–î–ö–õ–Æ–ß–ò–¢–¨ –ò –ü–†–û–í–ï–†–ò–¢–¨';
             status.textContent = res;
             status.style.color = 'green';
             google.script.run.withSuccessHandler(populateForm).getPublicAuthSettings();
          })
          .withFailureHandler((err) => {
             btn.disabled = false;
             btn.textContent = 'üöÄ –ü–û–î–ö–õ–Æ–ß–ò–¢–¨ –ò –ü–†–û–í–ï–†–ò–¢–¨';
             status.textContent = '‚ùå ' + err.message;
             status.style.color = 'red';
          })
          .connectBotToVk(formData);
      }

      function populateForm(settings) {
        if (settings.group_id) {
          document.getElementById('group_id').value = settings.group_id;
          document.getElementById('hint_group_id').textContent = '–¢–µ–∫—É—â–∏–π ID: ' + settings.group_id;
          updateLinks();
        }

        if (settings.web_app_url) {
          document.getElementById('web_app_url').value = settings.web_app_url;
          document.getElementById('hint_web_app_url').textContent = '–¢–µ–∫—É—â–∏–π URL: ' + (settings.web_app_url.substring(0, 40) + '...');
        }
        
        if (settings.has_user_token) {
          document.getElementById('user_token').placeholder = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢ (–°–æ—Ö—Ä–∞–Ω–µ–Ω)';
          document.getElementById('hint_user_token').textContent = 'Admin Token: ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω';
          document.getElementById('hint_user_token').style.color = 'green';
        }

        if (settings.has_vk_token) {
          document.getElementById('vk_token').placeholder = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢ (–°–æ—Ö—Ä–∞–Ω–µ–Ω)';
          document.getElementById('hint_vk_token').textContent = 'Group Token: ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω';
          document.getElementById('hint_vk_token').style.color = 'green';
        }
        
        if (settings.payment_phone) {
          document.getElementById('payment_phone').value = settings.payment_phone;
          document.getElementById('hint_payment_phone').textContent = '–¢–µ–∫—É—â–∏–π: ' + settings.payment_phone;
        }
        
        if (settings.payment_bank) {
          document.getElementById('payment_bank').value = settings.payment_bank;
          document.getElementById('hint_payment_bank').textContent = '–¢–µ–∫—É—â–∏–π: ' + settings.payment_bank;
        }
      }

      function handleFormSubmit() {
        const form = document.getElementById('authForm');
        const btn = document.querySelector('button.submit');
        const status = document.getElementById('status');
        
        btn.disabled = true;
        btn.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω—è—é...';
        
        const formData = {
          group_id: document.getElementById('group_id').value,
          web_app_url: document.getElementById('web_app_url').value,
          user_token: document.getElementById('user_token').value,
          vk_token: document.getElementById('vk_token').value,
          payment_phone: document.getElementById('payment_phone').value,
          payment_bank: document.getElementById('payment_bank').value,
          admin_password: form.admin_password.value
        };

        google.script.run
          .withSuccessHandler(function(response) {
            btn.disabled = false;
            btn.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç—ã';
            status.textContent = '‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!';
            status.style.color = 'green';
            setTimeout(() => google.script.host.close(), 1500);
          })
          .withFailureHandler(function(error) {
            btn.disabled = false;
            btn.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç—ã';
            status.textContent = '‚ùå ' + error.message;
            status.style.color = 'red';
          })
          .saveAuthSettings(formData);
      }

      function flashField(element) {
        element.style.backgroundColor = '#e8f5e9';
        setTimeout(() => element.style.backgroundColor = '', 800);
      }
    </script>
  </body>
</html>