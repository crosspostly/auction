<!DOCTYPE html>
<html>
  <head>
    <base target="_blank">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Roboto', sans-serif;
        padding: 15px;
        color: #333;
        font-size: 13px;
      }
      .form-group {
        margin-bottom: 12px;
      }
      label {
        display: block;
        margin-bottom: 4px;
        font-weight: 500;
        color: #555;
      }
      input[type="text"], input[type="password"] {
        flex-grow: 1;
        padding: 6px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
      }
      .input-wrapper {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .hint {
        font-size: 11px;
        color: #888;
        margin-top: 2px;
      }
      button {
        background-color: #1976d2;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
      }
      button.secondary {
        background-color: #eee;
        color: #333;
        border: 1px solid #ddd;
        padding: 6px 10px;
        font-size: 12px;
        white-space: nowrap;
      }
      button.secondary:hover {
        background-color: #e0e0e0;
      }
      button.action {
        background-color: #4caf50;
        width: 100%;
        margin-top: 5px;
        padding: 10px;
        font-weight: bold;
      }
      button.action:hover {
        background-color: #388e3c;
      }
      button.submit {
        width: 100%;
        margin-top: 15px;
        padding: 10px;
        font-size: 14px;
        background-color: #1976d2;
      }
      button.submit:hover {
        background-color: #1565c0;
      }
      .status {
        margin-top: 10px;
        font-size: 12px;
        text-align: center;
        min-height: 20px;
        white-space: pre-wrap;
      }
      .section-title {
        color: #1976d2;
        font-weight: 700;
        margin-top: 15px;
        margin-bottom: 8px;
        border-bottom: 1px dashed #ddd;
        padding-bottom: 4px;
        font-size: 14px;
      }
      h3 { margin-top: 0; font-size: 16px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
    </style>
  </head>
  <body>
    <h3>üîê –°–µ–∫—Ä–µ—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
    <form id="authForm" onsubmit="handleFormSubmit(this); return false;">
      
      <div class="section-title">üîë –î–æ—Å—Ç—É–ø –∫ VK (API)</div>

      <div class="form-group">
        <label>–¢–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞ (Access Token)</label>
        <div class="input-wrapper">
          <input type="password" id="vk_token" name="vk_token" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        <div class="hint">–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –∏–ª–∏ —Ç–æ–∫–µ–Ω. –ï—Å–ª–∏ —É–∂–µ –≤–≤–æ–¥–∏–ª–∏ - –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º.</div>
      </div>

      <div class="form-group">
        <label>ID –ì—Ä—É–ø–ø—ã (Group ID)</label>
        <div class="input-wrapper">
          <input type="text" id="group_id" name="group_id" placeholder="123456789">
          <button type="button" class="secondary" onclick="autoGetGroupId()">üîç –ù–∞–π—Ç–∏ ID</button>
        </div>
      </div>

      <div class="section-title">üöÄ –ê–≤—Ç–æ-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</div>
      
      <div class="form-group">
        <label>Web App URL</label>
        <div class="input-wrapper">
          <input type="text" id="web_app_url" name="web_app_url" placeholder="https://script.google.com/...">
        </div>
      </div>
      
      <button type="button" class="action" onclick="autoConnect()">üîå –ü–æ–¥–∫–ª—é—á–∏—Ç—å –±–æ—Ç–∞ –∫ VK</button>
      
      <div class="section-title">üí≥ –û–ø–ª–∞—Ç–∞ (–†–µ–∫–≤–∏–∑–∏—Ç—ã)</div>

      <div class="form-group">
        <label>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–°–ë–ü)</label>
        <div class="input-wrapper">
           <input type="text" id="payment_phone" name="payment_phone">
        </div>
      </div>

      <div class="form-group">
        <label>–ë–∞–Ω–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª—è</label>
        <div class="input-wrapper">
           <input type="text" id="payment_bank" name="payment_bank">
        </div>
      </div>
      
      <div class="section-title">üõ°Ô∏è –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è –∞–¥–º–∏–Ω–∞</div>
      
      <div class="form-group">
        <div class="input-wrapper">
           <input type="password" name="admin_password" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
        </div>
      </div>

      <button type="submit" id="submitBtn" class="submit">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å—ë</button>
    </form>
    
    <div id="status" class="status"></div>

    <script>
      google.script.run.withSuccessHandler(populateForm).getPublicAuthSettings();

      document.getElementById('vk_token').addEventListener('paste', function(e) {
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData).getData('text');
        const match = text.match(/access_token=([a-zA-Z0-9\.\-_]+)/);
        this.value = match ? match[1] : text.trim();
        flashField(this);
      });

      function autoGetGroupId() {
        const token = document.getElementById('vk_token').value;
        const input = document.getElementById('group_id');
        const btn = event.target;
        const status = document.getElementById('status');

        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = '...';
        
        google.script.run
          .withSuccessHandler(function(id) {
             btn.disabled = false;
             btn.textContent = originalText;
             input.value = id;
             flashField(input);
             status.textContent = '‚úÖ ID –≥—Ä—É–ø–ø—ã –Ω–∞–π–¥–µ–Ω!';
             status.style.color = 'green';
          })
          .withFailureHandler(function(error) {
             btn.disabled = false;
             btn.textContent = originalText;
             status.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + error.message;
             status.style.color = 'red';
          })
          .fetchVkGroupId(token, input.value);
      }

      function autoConnect() {
        const form = document.getElementById('authForm');
        const url = document.getElementById('web_app_url').value;
        const status = document.getElementById('status');
        const btn = event.target;

        if (!url) {
          status.textContent = '‚ùå –í–≤–µ–¥–∏—Ç–µ Web App URL!';
          status.style.color = 'red';
          return;
        }

        btn.disabled = true;
        btn.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
        status.textContent = '‚è≥ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –í–ö...';
        
        // 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –ø–æ–ª—è
        google.script.run
          .withSuccessHandler(() => {
             // 2. –ü–æ–¥–∫–ª—é—á–∞–µ–º
             google.script.run
               .withSuccessHandler((res) => {
                  btn.disabled = false;
                  btn.textContent = 'üîå –ü–æ–¥–∫–ª—é—á–∏—Ç—å –±–æ—Ç–∞ –∫ VK';
                  status.textContent = res;
                  status.style.color = 'green';
               })
               .withFailureHandler((err) => {
                  btn.disabled = false;
                  btn.textContent = 'üîå –ü–æ–¥–∫–ª—é—á–∏—Ç—å –±–æ—Ç–∞ –∫ VK';
                  status.textContent = '‚ùå ' + err.message;
                  status.style.color = 'red';
               })
               .connectBotToVk(url);
          })
          .saveAuthSettings(form);
      }

      function flashField(element) {
        const original = element.style.borderColor;
        element.style.borderColor = '#2e7d32';
        element.style.backgroundColor = '#e8f5e9';
        setTimeout(() => {
          element.style.borderColor = original;
          element.style.backgroundColor = '';
        }, 800);
      }

      function populateForm(settings) {
        if (settings.group_id) document.getElementById('group_id').value = settings.group_id;
        if (settings.web_app_url) document.getElementById('web_app_url').value = settings.web_app_url;
        if (settings.payment_phone) document.getElementById('payment_phone').value = settings.payment_phone;
        if (settings.payment_bank) document.getElementById('payment_bank').value = settings.payment_bank;
      }

      function handleFormSubmit(formObject) {
        const btn = document.getElementById('submitBtn');
        const status = document.getElementById('status');
        btn.disabled = true;
        btn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        status.textContent = '';
        
        google.script.run
          .withSuccessHandler(function(response) {
            btn.disabled = false;
            btn.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å—ë';
            status.textContent = '‚úÖ ' + response;
            status.style.color = 'green';
            setTimeout(() => google.script.host.close(), 1500);
          })
          .withFailureHandler(function(error) {
            btn.disabled = false;
            btn.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å—ë';
            status.textContent = '‚ùå ' + error.message;
            status.style.color = 'red';
          })
          .saveAuthSettings(formObject);
      }
    </script>
  </body>
</html>