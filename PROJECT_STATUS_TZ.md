# ТЕХНИЧЕСКОЕ ЗАДАНИЕ: ДОРАБОТКА VK AUCTION BOT (v2.1)

## 1. ТЕКУЩЕЕ СОСТОЯНИЕ ПРОЕКТА
Проект представляет собой автоматизированную систему проведения аукционов в сообществах ВКонтакте.
**Стек:** Google Apps Script (GAS), Google Sheets, VK API 5.131.
**Управление:** Реализовано через меню Google Таблицы + Сайдбар (инструкция) + Модальные окна.

### 2. ЧТО УЖЕ РЕАЛИЗОВАНО:
1.  **Мастер настройки:** Автоматическое создание 6 листов (Лоты, Ставки, Победители, Настройки, Очередь, Ошибки) с описаниями полей.
2.  **Безопасность:**
    *   Чувствительные данные (Токен ВК, Реквизиты) хранятся в `PropertiesService`.
    *   Доступ к настройкам защищен паролем администратора.
    *   Система блокировки (5 попыток на 6 часов) для защиты от брутфорса.
3.  **Интеграция с ВК:**
    *   Авто-поиск числового ID группы по ссылке.
    *   Авто-получение кода подтверждения Callback API.
    *   Функция «Кнопка Счастья» — автоматическая регистрация Callback-сервера в настройках группы.
4.  **Логика аукциона:**
    *   **Универсальный парсер лотов:** Распознает форматы `№123`, `Старт 150`, `Дедлайн 13.12.2025 21:00`.
    *   **Поддержка дедлайнов:** Бот проверяет дату окончания перед приемом ставки.
    *   **Проверка лички:** Если у пользователя закрыты сообщения, бот отвечает ему в комментариях с просьбой открыть доступ.
    *   **Очередь уведомлений:** Защита от спам-фильтров ВК (отправка порциями).

---

## 3. ТЕКУЩИЕ ПРОБЛЕМЫ (ЧТО НУЖНО ИСПРАВИТЬ):
1.  **Ошибка 2000 (Servers number limit):** В ВК лимит 25 серверов. Нужно добавить в код `manageCallbackServer` очистку старых серверов с тем же заголовком (`GAS_Auction`), если лимит достигнут.
2.  **Продление аукциона (Анти-снайпер):** В ТЗ указано: если ставка за 10 мин до конца, продлевать на 10 мин. В коде `handleWallReplyNew` это место помечено как `TODO`. Нужно реализовать.
3.  **Логика победителей:** Доработать финализацию, чтобы бот корректно группировал лоты одного человека в одну рассылку ("Вы выиграли 3 лота...").

## 4. ЗАДАЧИ ДЛЯ ИСПОЛНИТЕЛЯ:

### Задача №1: Интеллектуальное управление Callback-серверами
*   При вызове `addCallbackServer`, если получаем ошибку 2000, бот должен найти в списке серверов те, что имеют заголовок `GAS_Auction` или `Google Auction Bot`, удалить самый старый из них и попробовать снова.

### Задача №2: Реализация "Анти-снайпера"
*   В функции `handleWallReplyNew` добавить расчет: если `now` > `deadline - 10 минут`, то `new_deadline = now + 10 минут`.
*   Обновить значение `deadline` в таблице (лист Лоты).

### Задача №3: Дизайн и юзабилити сообщений
*   Добавить в рассылку победителю ссылки на выигранные лоты в формате `vk.com/wall-XXX_YYY`.
*   Сделать отчет для админа в ЛС по окончании аукциона (список всех проданных лотов и итоговая сумма).

---

## 5. ПОЛЕЗНЫЕ ДАННЫЕ
*   **Web App URL:** `https://script.google.com/macros/s/AKfycbwm3U_WM7LbZmODcXFiJPLdBz117fvGKZskaea0j9K5s_2tKptMncPhSAOnmlMoR3DG/exec`
*   **Тестовая группа:** `https://vk.com/club96798355` (ID 96798355)
