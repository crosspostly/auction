<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Roboto', sans-serif;
        padding: 20px;
        color: #333;
        text-align: center;
      }
      .container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
      }
      input[type="password"] {
        padding: 10px;
        font-size: 16px;
        border: 1px solid #ddd;
        border-radius: 4px;
        width: 80%;
        margin-bottom: 15px;
        text-align: center;
      }
      button {
        background-color: #1976d2;
        color: white;
        border: none;
        padding: 10px 20px;
        font-size: 14px;
        border-radius: 4px;
        cursor: pointer;
        width: 100%;
      }
      button:hover {
        background-color: #1565c0;
      }
      .error {
        color: #c62828;
        margin-top: 10px;
        font-size: 13px;
        min-height: 20px;
      }
      h3 { margin-top: 0; }
    </style>
  </head>
  <body>
    <div class="container" id="loginForm">
      <h3 id="title">üîê –í—Ö–æ–¥ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
      <p id="subtitle" style="font-size: 13px; color: #666; margin-bottom: 15px;">–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</p>
      
      <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" autofocus>
      <button onclick="submitPassword()" id="btn">–í–æ–π—Ç–∏</button>
      <div id="error" class="error"></div>
    </div>

    <script>
      // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å (–Ω—É–∂–Ω–æ –ª–∏ —Å–æ–∑–¥–∞—Ç—å –ø–∞—Ä–æ–ª—å –∏–ª–∏ –æ–Ω —É–∂–µ –µ—Å—Ç—å)
      google.script.run.withSuccessHandler(init).getAuthStatus();

      let mode = 'login'; // 'login' or 'create'

      function init(status) {
        const title = document.getElementById('title');
        const subtitle = document.getElementById('subtitle');
        const btn = document.getElementById('btn');

        if (status.isBlocked) {
          document.body.innerHTML = `<h3 style="color: #c62828;">‚õî –î–æ—Å—Ç—É–ø –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</h3><p>–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫.</p><p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑: <b>${status.waitHours}</b></p>`;
          return;
        }

        if (!status.hasPassword) {
          mode = 'create';
          title.textContent = 'üÜï –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä–æ–ª—è';
          subtitle.textContent = '–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º (–µ–≥–æ –±—É–¥—É—Ç –∑–Ω–∞—Ç—å —Ç–æ–ª—å–∫–æ –≥–ª–∞–≤–Ω—ã–µ –∞–¥–º–∏–Ω—ã).';
          btn.textContent = '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å';
        }
      }

      function submitPassword() {
        const pass = document.getElementById('password').value;
        const error = document.getElementById('error');
        const btn = document.getElementById('btn');

        if (!pass) {
          error.textContent = '–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å';
          return;
        }

        btn.disabled = true;
        error.textContent = '';

        if (mode === 'create') {
          google.script.run
            .withSuccessHandler(() => {
              // –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ä–∞–∑—É –æ—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
               google.script.run.openSettingsDialog();
               google.script.host.close();
            })
            .setPassword(pass);
        } else {
          google.script.run
            .withSuccessHandler((result) => {
              if (result.success) {
                google.script.run.openSettingsDialog();
                google.script.host.close();
              } else {
                btn.disabled = false;
                error.textContent = result.message;
                if (result.blocked) {
                   setTimeout(() => google.script.host.close(), 3000);
                }
              }
            })
            .verifyPassword(pass);
        }
      }
    </script>
  </body>
</html>