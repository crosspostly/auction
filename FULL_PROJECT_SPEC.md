# ПОЛНАЯ ТЕХНИЧЕСКАЯ СПЕЦИФИКАЦИЯ ПРОЕКТА: VK AUCTION BOT

**Версия:** 2.3
**Дата:** 11.02.2026
**Статус:** Реализовано и документировано
**Платформа:** Google Apps Script + Google Sheets + VK Callback API

---

## 1. ОБЩЕЕ ОПИСАНИЕ СИСТЕМЫ

### 1.5. Двухтокенная архитектура (НОВОЕ в v2.3)

Для обхода ограничений VK API и повышения надежности система использует разделение прав доступа:
*   **Admin (User) Token**: Используется для административных действий — создание Callback-серверов, получение кодов подтверждения, удаление тестовых постов. Требует прав `groups, wall, offline`.
*   **Group Token**: Используется ботом для операционной деятельности — отправка сообщений участникам, публикация комментариев под лотами. Привязан к конкретной группе.

---

## 2. АРХИТЕКТУРА СИСТЕМЫ

### 2.5. Мастер подключения (4 шага)

Процесс инициализации бота полностью автоматизирован через диалоговое окно «Настройки авторизации»:
1.  **Идентификация**: Ввод ссылки на группу (ID извлекается автоматически).
2.  **Admin Access**: Получение токена пользователя через Standalone-приложение.
3.  **Group Access**: Получение токена сообщества.
4.  **Синхронизация**: Скрипт сам настраивает Callback API и выполняет «Тихую проверку» (создает и мгновенно удаляет проверочный пост), гарантируя работоспособность перед запуском.
\n\n### 1.1. Введение\n\nПроект представляет собой автоматизированную систему для проведения аукционов в социальной сети ВКонтакте. В основе лежит Google Apps Script (GAS), который служит бэкендом, взаимодействуя с VK API через Callback API и управляя данными в Google Sheets. Система спроектирована для максимальной автономности и простоты управления для администраторов сообществ, не требуя навыков программирования для повседневной работы.\n\n### 1.2. Цели и задачи\n\n*   **Автоматизация:** Максимально автоматизировать рутинные процессы, связанные с проведением аукционов (обнаружение лотов, прием ставок, определение победителей, уведомления).\n*   **Надежность:** Обеспечить стабильную работу системы даже при пиковых нагрузках и временных сбоях внешних API.\n*   **Гибкость:** Предоставить администраторам возможность легко настраивать параметры аукциона и шаблоны сообщений через Google Таблицы.\n*   **Прозрачность:** Вести подробный журнал всех событий для отладки, мониторинга и анализа.\n*   **Тестируемость:** Включить встроенный симулятор для удобной проверки функциональности и генерации тестовых данных.\n\n### 1.3. Целевая аудитория\n\n*   **Администраторы сообществ VK:** Основные пользователи, которые публикуют лоты, настраивают правила аукциона и контролируют его ход через Google Таблицу.\n*   **Участники аукциона:** Пользователи VK, которые делают ставки и получают автоматические уведомления от бота.\n\n### 1.4. Глоссарий\n\n| Термин          | Описание                                                                  |\n| :-------------- | :------------------------------------------------------------------------ |\n| **Лот**         | Товар, выставленный на аукцион (один пост VK = один лот).                 |\n| **Ставка**      | Предложение цены в комментарии к посту лота.                              |\n| **Победитель**  | Участник с максимальной валидной ставкой на момент окончания аукциона.    |\
| **Аукцион**     | Серия лотов, проводимая по определенному расписанию (например, еженедельно). |\
| **GAS**         | Google Apps Script — бессерверная платформа Google для выполнения JavaScript-кода. |\
| **Callback API** | VK API для получения событий в реальном времени (через webhook).          |\
| **user_id**     | Числовой идентификатор пользователя ВКонтакте.                            |\
| **post_id**     | Идентификатор поста VK в формате `ownerID_postID`.                        |\
| **comment_id**  | Идентификатор комментария VK.                                             |\
| **doPost()**    | Точка входа для обработки входящих webhook-событий от VK.                 |\
| **LockService** | Механизм блокировки в GAS для защиты от состояний гонки (race conditions). |\
| **EventQueue**  | Лист Google Sheets, используемый как очередь для всех входящих событий VK. |\
| **NotificationQueue** | Лист Google Sheets, используемый как очередь для всех исходящих уведомлений. |\
| **Monitoring**  | Независимый модуль для логирования ключевых событий в лист \"Статистика\". |\
| **Симулятор**   | Модуль `AuctionSimulator.gs` для генерации тестовых постов и ставок в VK. |\
\n---\n\n## 2. АРХИТЕКТУРА СИСТЕМЫ\n\n### 2.1. Высокоуровневая схема\n\n```\n┌───────────────────────────────────────────────────────────┐\n│            УРОВЕНЬ 1: VK (Источник событий)                │\n│    • Новые посты (wall_post_new)                           │\n│    • Комментарии (wall_reply_new)                          │\n│    • Личные сообщения (message_new)                        │\n└─────────────────────┬─────────────────────────────────────┘\n                      │ Callback API (Webhook, HTTP POST)\n                      │ (Требование VK: ответ 'ok' за 5 секунд)\n                      ▼\n┌───────────────────────────────────────────────────────────┐\n│      УРОВЕНЬ 2: Google Apps Script (Логика бота)          │\n│  ┌─────────────────────────────────────────────────────┐  │
│  │ `doPost(e)`: Мгновенная обработка и ответ 'ok'        │  │
│  │              (Логирует в `Incoming`, вызывает `routeEvent`) │  │
│  │              (При ошибке сохраняет в `EventQueue`)    │  │
│  ├─────────────────────────────────────────────────────┤  │
│  │ `periodicSystemCheck()`: (Триггер: каждые 10 мин)    │  │
│  │    • `processEventQueue()`: Обработка ошибок из буфера│  │
│  │    • Мониторинг здоровья системы                      │  │
│  ├─────────────────────────────────────────────────────┤  │\n│  │ `handleWallPostNew()`: Парсинг лота, запись в \"Лоты\"  │  │\n│  ├─────────────────────────────────────────────────────┤  │\n│  │ `handleWallReplyNew()`:                              │  │\n│  │    • `LockService` для защиты от race conditions      │  │\n│  │    • Валидация ставки (`validateBid`):                │  │\n│  │        • Проверка дедлайна, `max_bid`, `current_price`, `bid_step` |\n│  │    • Запись валидной ставки в \"Ставки\"                │  │\n│  │    • Обновление \"Лотов\" (current_price, leader_id)    │  │\n│  │    • Логика продления дедлайна аукциона               │  │\n│  │    • Постановка уведомлений (`outbid`, `low_bid`) в `NotificationQueue` |\n│  ├─────────────────────────────────────────────────────┤  │\n│  │ `processNotificationQueue()`: (Триггер: каждую минуту) │  │\n│  │    • Извлекает уведомления из `NotificationQueue`     │  │\n│  │    • `sendNotification()`: Отправляет ЛС/комментарии через VK API (с rate limiting) |\n│  ├─────────────────────────────────────────────────────┤  │\n│  │ `finalizeAuction()`: (Триггер: еженедельно)           │  │\n│  │    • Определение победителей, запись в \"Победители\"   │  │\n│  │    • Отправка уведомлений `winner`                     │  │\n│  ├─────────────────────────────────────────────────────┤  │\n│  │ `AuctionSimulator.gs`: (Триггер: ежечасно/вручную)    │  │\n│  │    • Генерация тестовых постов-лотов и комментариев   │  │\n│  │      в VK (с разными сценариями ставок, разными пользователями) |\n│  ├─────────────────────────────────────────────────────┤  │\n│  │ Общие модули: `Sheets.gs` (работа с таблицами), `VkApi.gs` (оболочка VK API), `Monitoring.gs` (логирование) │  │\n│  └─────────────────────────────────────────────────────┘  │\n└─────────────────────┬─────────────────────────────────────┘\n                      │\n                      ▼\n┌───────────────────────────────────────────────────────────┐\n│         УРОВЕНЬ 3: Google Sheets (Хранилище Данных)        │\n│    • \"Лоты\" (`Config`)                                    │\n│    • \"Ставки\" (`Bids`)                                    │\n│    • \"Победители\" (`Winners`)                             │\n│    • \"Настройки\" (`Settings`)                             │\n│    • \"Статистика\" (`Statistics`)                          │\n│    • \"Очередь Событий\" (`EventQueue`)                     │\n│    • \"Очередь\" (`NotificationQueue`)                      │\n│    • \"Журнал\" (`Logs`)                                    │\n└─────────────────────┬─────────────────────────────────────┘\n                      │\n                      ▼\n┌───────────────────────────────────────────────────────────┐\n│         УРОВЕНЬ 4: VK API (Исходящие действия)            │\n│    • `messages.send` (ЛС уведомления)                     │\n│    • `wall.createComment` (Комментарии)                   │\n│    • `wall.post` (Посты от симулятора)                    │\n└───────────────────────────────────────────────────────────┘\n```\n\n### 2.2. Технологический стек\n\n*   **Серверная логика:** Google Apps Script (JavaScript ES6+)\n    *   **Обоснование:** Бесплатный хостинг, глубокая интеграция с Google Sheets, автоматический HTTPS, достаточные квоты для заявленной нагрузки.\n*   **База данных:** Google Sheets\n    *   **Обоснование:** Простота управления для администратора, привычный интерфейс, нормализованная структура данных, возможность использования формул для отчетов, бесплатное и неограниченное хранение в рамках Google Drive.\n*   **VK Интеграция:** VK Callback API + VK API 5.199 (или выше)\n    *   **Обоснование:** Получение событий в реальном времени, возможность совершать исходящие действия (отправка сообщений, постов, комментариев).\n*   **Защита от Race Conditions:** `LockService` (встроенный в GAS)\n    *   **Обоснование:** Обеспечение атомарности операций при одновременных ставках, предотвращение дублирования победителей. Таймаут `LockService` настроен на 5 секунд, чтобы уложиться в лимит `doPost()`.\n*   **Rate Limiting:** Очереди с искусственной задержкой (`Utilities.sleep()`)\n    *   **Обоснование:** Соблюдение лимита VK API в 3 запроса/секунду для исходящих действий (уведомлений, комментариев). Задержка 350 мс обеспечивает безопасный уровень ≈2.85 запроса/сек.\n*   **Асинхронная обработка событий:** Time-driven триггеры + `EventQueue`\n    *   **Обоснование:** Позволяет `doPost()` мгновенно отвечать VK, избегая тайм-аутов. Вся основная логика обработки событий вынесена в отдельную функцию, запускаемую по триггеру (каждую минуту).\n*   **Асинхронная обработка уведомлений:** Time-driven триггеры + `NotificationQueue`\n    *   **Обоснование:** Разделение процесса формирования и отправки уведомлений. Позволяет применять дебонс (защиту от спама) и `rate limiting` без блокировки основной логики. Уведомления сохраняются при временных сбоях VK API.\n*   **Планировщик задач:** Time-driven триггеры (встроенные в GAS)\n    *   **Обоснование:** Автоматический запуск `processEventQueue` и `processNotificationQueue` (каждую минуту), `finalizeAuction` (еженедельно), `runSingleSimulation` (ежечасно).\n*   **Мониторинг:** `Monitoring.gs` + лист \"Статистика\"\n    *   **Обоснование:** Независимый и легковесный механизм для логирования всех ключевых событий системы, критически важный для отладки, аудита и анализа производительности.\n*   **Симулятор:** `AuctionSimulator.gs`\n    *   **Обоснование:** Инструмент для тестирования системы в условиях, приближенных к реальным, без необходимости ручной генерации постов и комментариев.\n\n### 2.3. Взаимодействие с VK API\n\n#### 2.3.1. Callback API Events\n\n| Event Type      | Обработчик (`Code.gs`)           | Метод обработки | Время обработки (в `doPost`) |\
| :-------------- | :------------------------------- | :-------------- | :---------------------------- |\
| `confirmation`  | `doPost()`                       | Синхронно       | < 100ms                       |\
| `wall_post_new` | `enqueueEvent()` -> `processEventQueue()` -> `handleWallPostNew()` | Асинхронно      | < 2 сек (ответ VK), ~1-3 мин (полная) |\
| `wall_reply_new` | `enqueueEvent()` -> `processEventQueue()` -> `handleWallReplyNew()` | Асинхронно      | < 2 сек (ответ VK), ~1-3 мин (полная) |\
| `message_new`   | `enqueueEvent()` -> `processEventQueue()` -> `handleMessageNew()` | Асинхронно      | < 2 сек (ответ VK), ~1-3 мин (полная) |\
\n**Важное замечание:** Все обработчики `doPost()` гарантированно отвечают `\"ok\"` VK в течение 2 секунд, вынося сложную логику в асинхронные очереди для обеспечения стабильности.\n\n#### 2.3.2. VK API Methods\n\n| Метод               | Назначение                              | Частота                       | Rate Limit | Обработка                                    |\
| :------------------ | :-------------------------------------- | :---------------------------- | :--------- | :------------------------------------------- |\
| `messages.send`     | Отправка ЛС (уведомления, сводки)       | ~100-150/аукцион              | 3/сек      | `NotificationQueue` + `processNotificationQueue()` с задержкой |\
| `wall.createComment` | Комментарии (победители, симулятор)     | ~15-30/аукцион + симулятор   | 3/сек      | `NotificationQueue` / напрямую в симуляторе |\
| `groups.getById`    | Получение инфо о группе                 | По требованию                 | 3/сек      | Напрямую через `callVk`                      |\
| `users.get`         | Получение ФИО пользователя              | ~15/аукцион                   | 3/сек      | Напрямую через `callVk`                      |\
| `wall.post`         | Публикация постов симулятором           | ~1-5/час (для симулятора)    | 50/день    | Напрямую через `callVk` в симуляторе       |\
\n### 2.4. Нюансы реализации и лучшие практики\n\n*   **Асинхронность:** Ключевой архитектурный принцип, обеспечивающий соответствие требованиям VK API по времени ответа и повышающий надежность системы за счет устойчивости к временным сбоям.\n*   **`LockService`:** Используется для всех критических операций с данными лотов (`handleWallReplyNew`) для предотвращения `race conditions`. Это гарантирует, что даже при одновременных ставках данные обрабатываются последовательно и корректно.\n*   **Универсальный `callVk`:** Функция `callVk` (`VkApi.gs`) абстрагирует взаимодействие с VK API, позволяя легко переключать `access_token` (для бота или для симулятора), обрабатывает параметры и ошибки.\n*   **Модульность:** Код разбит на логические модули (`Code.gs`, `Sheets.gs`, `VkApi.gs`, `Monitoring.gs`, `AuctionSimulator.gs`), что улучшает читаемость, поддерживаемость и возможность тестирования.\n*   **Настройки через Google Sheets и `PropertiesService`:** Публичные настройки (шаг ставки, правила доставки) хранятся в листе \"Настройки\". Чувствительные данные (токены VK, пароли) хранятся в `PropertiesService`, обеспечивая безопасность и не требуя изменения кода для настройки.\n*   **Подробное логирование:** Модуль `Monitoring.gs` и лист \"Статистика\" предоставляют детализированный журнал всех ключевых событий системы, что бесценно для отладки, аудита и понимания поведения аукциона.\n*   **Гибкий парсинг:** Регулярные выражения для извлечения данных из постов и комментариев спроектированы максимально гибкими, чтобы справляться с небольшими отклонениями в форматировании.\n\n---\n\n## 3. СТРУКТУРА GOOGLE SHEETS (БАЗА ДАННЫХ)\n\nСистема автоматически создает и поддерживает следующие листы:\n\n### 3.1. Лист «Лоты» (`Config`)\n\n**Описание:** Главный реестр всех лотов аукциона. Заполняется автоматически при публикации поста в VK с маркером `#аукцион`. Поля `current_price` и `leader_id` динамически обновляются по мере поступления новых ставок. `deadline` может быть автоматически продлен.\n\n| Поле            | Тип      | Описание                                                            | Пример              |\
| :-------------- | :------- | :------------------------------------------------------------------ | :------------------ |\
| `lot_id`        | String   | Уникальный идентификатор лота (из поста или сгенерированный).       | `1840`, `SIM_abc123` |\
| `post_id`       | String   | Полный идентификатор поста VK (`ownerID_postID`).                   | `-202389657_48965`  |\
| `name`          | String   | Название лота, извлеченное из текста поста.                         | `Фигурка Space Marine` |\
| `start_price`   | Number   | Начальная цена лота.                                                | `300`               |\
| `current_price` | Number   | Текущая максимальная ставка по лоту.                                | `550`               |\
| `leader_id`     | String   | `user_id` текущего лидера (участника с максимальной ставкой).       | `67890`             |\
| `status`        | String   | Текущий статус лота (`active`, `sold`, `unsold`, `cancelled`).      | `active`            |\
| `created_at`    | Date     | Дата и время создания записи лота.                                  | `2026-02-08 10:00:00` |\
| `deadline`      | Date     | Дата и время окончания аукциона (может быть продлено).             | `2026-02-08 21:00:00` |\
| `bid_step`      | Number   | Минимальный шаг ставки для данного лота.                           | `50`                |\
\n### 3.2. Лист «Ставки» (`Bids`)\n\n**Описание:** Подробный, полный журнал всех валидных ставок, сделанных участниками аукциона. Этот лист критически важен для отслеживания истории торгов по каждому лоту, а также для определения победителя (учитывается самая высокая и самая ранняя ставка при равенстве сумм).\n\n| Поле          | Тип      | Описание                                                            | Пример                |\
| :------------ | :------- | :------------------------------------------------------------------ | :-------------------- |\
| `bid_id`      | String   | Уникальный идентификатор каждой ставки (UUID).                      | `UUID_1`              |\
| `lot_id`      | String   | `lot_id`, к которому относится ставка.                              | `1691`                |\
| `user_id`     | String   | `user_id` участника, сделавшего ставку.                             | `12345`               |\
| `bid_amount`  | Number   | Сумма ставки.                                                       | `500`                 |\
| `timestamp`   | Date     | Точное время, когда ставка была зафиксирована системой.            | `2026-02-08 14:30:15` |\
| `comment_id`  | String   | Идентификатор комментария VK, в котором была сделана ставка.       | `777`                 |\
\n### 3.3. Лист «Победители» (`Winners`)\n\n**Описание:** Реестр победителей аукционов. Заполняется после финализации аукциона. Используется для управления последующими этапами (контакт, доставка, оплата).\n\n| Поле          | Тип      | Описание                                                            | Пример                  |\
| :------------ | :------- | :------------------------------------------------------------------ | :---------------------- |\
| `lot_id`      | String   | `lot_id` выигранного лота.                                          | `1691`                  |\
| `name`        | String   | Название выигранного лота.                                         | `Фигурка Space Marine`  |\
| `price`       | Number   | Финальная цена, за которую был выигран лот.                       | `550`                   |\
| `winner_id`   | String   | `user_id` победителя.                                               | `67890`                 |\
| `winner_name` | String   | Имя победителя (запрашивается из VK API на момент финализации).   | `Иван Иванов`           |\
| `won_at`      | Date     | Дата и время определения победителя.                               | `2026-02-08 21:00:00`   |\
| `status`      | String   | Статус обработки заказа (`pending_contact`, `summary_sent`, `paid`, `shipped`). | `pending_contact`       |\
| `delivery`    | Number   | Рассчитанная стоимость доставки.                                  | `450`                   |\
| `paid`        | Boolean  | `TRUE`, если оплата получена.                                       | `FALSE`                 |\
| `shipped`     | Boolean  | `TRUE`, если товар отправлен.                                       | `FALSE`                 |\
\n### 3.4. Лист «Настройки» (`Settings`)\n\n**Описание:** Key-value хранилище для публичных параметров работы бота, которые администратор может легко менять через таблицу. Чувствительные данные (`VK_TOKEN`, `VK_SECRET`, `ADMIN_PASSWORD` и т.п.) хранятся в `PropertiesService` и настраиваются через меню **VK Auction -> Настройка авторизации (VK)**.\n\n| Ключ (`setting_key`) | Значение (`setting_value`) | Описание                                             |\
| :------------------- | :------------------------- | :--------------------------------------------------- |\
| `DEBUG_VK_API`       | `TRUE`/`FALSE`             | Включить подробное логирование запросов к VK API.    |\
| `bid_step_enabled`   | `TRUE`/`FALSE`             | Включить проверку кратности шага ставки.             |\
| `bid_step`           | Number                     | Размер шага ставки (например, `50`).                 |\
| `subscription_check_enabled` | `TRUE`/`FALSE`       | Проверять подписку на группу перед приемом ставки.   |\
| `debug_logging_enabled` | `TRUE`/`FALSE`            | Включить подробные технические логи.                 |\
| `reply_on_invalid_bid_enabled` | `TRUE`/`FALSE`     | Отвечать комментарием на некорректные ставки.        |\
| `send_winner_dm_enabled` | `TRUE`/`FALSE`           | Отправлять победителю сообщение в ЛС.                |\
| `min_bid_increment`  | Number                     | Минимальная надбавка к текущей цене лота.            |\
| `max_bid`            | Number                     | Максимально допустимая сумма ставки (защита от опечаток). |\
| `delivery_rules`     | JSON String                | Правила расчета стоимости доставки.                  |\
| `order_summary_template` | String                 | Шаблон сообщения победителю с деталями заказа.       |\
| `payment_phone`      | String                     | Телефон для оплаты (отображается в сводке).          |\
| `payment_bank`       | String                     | Название банка для оплаты (отображается в сводке).   |\
\n### 3.5. Лист «Статистика» (`Statistics`)\n\n**Описание:** Независимый и подробный журнал всех ключевых событий, происходящих в системе. Используется для отладки, мониторинга, анализа поведения аукциона и работы симулятора.\n\n| Поле        | Тип      | Описание                                                            | Пример                                       |\
| :---------- | :------- | :------------------------------------------------------------------ | :------------------------------------------- |\
| `Timestamp` | Date     | Дата и время события.                                               | `2026-02-08 14:30:00`                        |\
| `EventType` | String   | Тип произошедшего события (например, `LOT_CREATED`, `BID_VALIDATED`). | `BID_RECORDED`                               |\
| `Details`   | JSON String | Детали события в формате JSON.                                     | `{ \"lot_id\": \"1691\", \"user_id\": \"12345\", ... }` |\
\n### 3.6. Лист «Очередь Событий» (`EventQueue`)\n\n**Описание:** Буфер для всех входящих событий от VK Callback API. `doPost()` быстро записывает сюда сырые данные, а отдельный триггер (`processEventQueue()`) затем асинхронно обрабатывает их. Это гарантирует мгновенный ответ VK и предотвращает потерю событий.\n\n| Поле        | Тип      | Описание                                                            | Пример |\
| :---------- | :------- | :------------------------------------------------------------------ | :----- |\
| `eventId`   | String   | Уникальный идентификатор события (UUID).                            | `UUID_1` |\
| `payload`   | JSON String | Полный JSON-объект webhook-события от VK.                          | `{... VK webhook JSON ...}` |\
| `status`    | String   | Статус обработки события (`pending`, `processed`, `failed`).        | `pending` |\
| `receivedAt` | Date     | Время получения события.                                            | `2026-02-08 14:30:00` |\
\n### 3.7. Лист «Очередь» (`NotificationQueue`)\n\n**Описание:** Буфер для всех исходящих уведомлений (ЛС и комментариев), которые должны быть отправлены пользователям. Отдельный триггер (`processNotificationQueue()`) обрабатывает эту очередь, соблюдая `rate limits` VK API и дебонс, чтобы избежать спама.\n\n| Поле            | Тип      | Описание                                                            | Пример                               |\
| :-------------- | :------- | :------------------------------------------------------------------ | :----------------------------------- |\
| `queue_id`      | String   | Уникальный идентификатор уведомления (UUID).                        | `UUID_1`                             |\
| `user_id`       | String   | `user_id` получателя уведомления.                                   | `12345`                              |\
| `type`          | String   | Тип уведомления (`outbid`, `low_bid`, `winner`).                    | `outbid`                             |\
| `payload`       | JSON String | Детали уведомления в JSON-формате (зависит от `type`).           | `{\"lot_id\":\"1691\",...}`           |\
| `status`        | String   | Статус отправки (`pending`, `sent`, `failed`).                      | `pending`                            |\
| `created_at`    | Date     | Время создания уведомления.                                         | `2026-02-08 14:30:00`                |\
| `processed_at`  | Date     | Время отправки/обработки уведомления.                              |                                      |\
| `send_after`    | Date     | Опционально: время, после которого можно отправлять уведомление. |                                      |\
\n### 3.8. Лист «Журнал» (`Logs`)\n\n**Описание:** Общий журнал для всех информационных сообщений, предупреждений и критических ошибок системы. Используется для оперативного мониторинга и отладки.\n\n| Поле      | Тип      | Описание                                                            | Пример                                       |\
| :-------- | :------- | :------------------------------------------------------------------ | :------------------------------------------- |\
| `date`    | Date     | Дата и время записи.                                                | `2026-02-08 14:30:00`                        |\
| `type`    | String   | Тип записи (`ИНФО`, `ОШИБКА`, `ПРЕДУПРЕЖДЕНИЕ`).                     | `ОШИБКА`                                     |\
| `message` | String   | Краткое сообщение о событии.                                        | `[processEvent_failed] Ошибка парсинга`      |\
| `details` | JSON String | Дополнительные детали в JSON-формате (например, полный `payload` ошибки). | `{ \"error\": \"...\", \"event_data\": \"...\" }` |\
\n### 3.5. Лист «Статистика» (`Statistics`)\n\n**Описание:** Независимый и подробный журнал всех ключевых событий, происходящих в системе. Используется для отладки, мониторинга, анализа поведения аукциона и работы симулятора.\n\n| Поле        | Тип      | Описание                                                            | Пример                                       |\
| :---------- | :------- | :------------------------------------------------------------------ | :------------------------------------------- |\
| `Timestamp` | Date     | Дата и время события.                                               | `2026-02-08 14:30:00`                        |\
| `EventType` | String   | Тип произошедшего события (например, `LOT_CREATED`, `BID_VALIDATED`). | `BID_RECORDED`                               |\
| `Details`   | JSON String | Детали события в формате JSON.                                     | `{ \"lot_id\": \"1691\", \"user_id\": \"12345\", ... }` |\
\n### 3.6. Лист «Очередь Событий» (`EventQueue`)\n\n**Описание:** Буфер для всех входящих событий от VK Callback API. `doPost()` быстро записывает сюда сырые данные, а отдельный триггер (`processEventQueue()`) затем асинхронно обрабатывает их. Это гарантирует мгновенный ответ VK и предотвращает потерю событий.\n\n| Поле        | Тип      | Описание                                                            | Пример |\
| :---------- | :------- | :------------------------------------------------------------------ | :----- |\
| `eventId`   | String   | Уникальный идентификатор события (UUID).                            | `UUID_1` |\
| `payload`   | JSON String | Полный JSON-объект webhook-события от VK.                          | `{... VK webhook JSON ...}` |\
| `status`    | String   | Статус обработки события (`pending`, `processed`, `failed`).        | `pending` |\
| `receivedAt` | Date     | Время получения события.                                            | `2026-02-08 14:30:00` |\
\n### 3.7. Лист «Очередь» (`NotificationQueue`)\n\n**Описание:** Буфер для всех исходящих уведомлений (ЛС и комментариев), которые должны быть отправлены пользователям. Отдельный триггер (`processNotificationQueue()`) обрабатывает эту очередь, соблюдая `rate limits` VK API и дебонс, чтобы избежать спама.\n\n| Поле            | Тип      | Описание                                                            | Пример                               |\
| :-------------- | :------- | :------------------------------------------------------------------ | :----------------------------------- |\
| `queue_id`      | String   | Уникальный идентификатор уведомления (UUID).                        | `UUID_1`                             |\
| `user_id`       | String   | `user_id` получателя уведомления.                                   | `12345`                              |\
| `type`          | String   | Тип уведомления (`outbid`, `low_bid`, `winner`).                    | `outbid`                             |\
| `payload`       | JSON String | Детали уведомления в JSON-формате (зависит от `type`).           | `{\"lot_id\":\"1691\",...}`           |\
| `status`        | String   | Статус отправки (`pending`, `sent`, `failed`).                      | `pending`                            |\
| `created_at`    | Date     | Время создания уведомления.                                         | `2026-02-08 14:30:00`                |\
| `processed_at`  | Date     | Время отправки/обработки уведомления.                             |                                      |\
| `send_after`    | Date     | Опционально: время, после которого можно отправлять уведомление. |                                      |\
\n### 3.8. Лист «Журнал» (`Logs`)\n\n**Описание:** Общий журнал для всех информационных сообщений, предупреждений и критических ошибок системы. Используется для оперативного мониторинга и отладки.\n\n| Поле      | Тип      | Описание                                                            | Пример                                       |\
| :-------- | :------- | :------------------------------------------------------------------ | :------------------------------------------- |\
| `date`    | Date     | Дата и время записи.                                                | `2026-02-08 14:30:00`                        |\
| `type`    | String   | Тип записи (`ИНФО`, `ОШИБКА`, `ПРЕДУПРЕЖДЕНИЕ`).                     | `ОШИБКА`                                     |\
| `message` | String   | Краткое сообщение о событии.                                        | `[processEvent_failed] Ошибка парсинга`      |\
| `details` | JSON String | Дополнительные детали в JSON-формате (например, полный `payload` ошибки). | `{ \"error\": \"...\", \"event_data\": \"...\" }` |\
| `date`    | Date     | Дата и время записи.                                                | `2026-02-08 14:30:00`                        |\
| `type`    | String   | Тип записи (`ИНФО`, `ОШИБКА`, `ПРЕДУПРЕЖДЕНИЕ`).                     | `ОШИБКА`                                     |\
| `message` | String   | Краткое сообщение о событии.                                        | `[processEvent_failed] Ошибка парсинга`      |\
| `details` | JSON String | Дополнительные детали в JSON-формате (например, полный `payload` ошибки). | `{ \"error\": \"...\", \"event_data\": \"...\" }` |\
\n---\n\n## 4. ФУНКЦИОНАЛЬНЫЕ ВОЗМОЖНОСТИ\n\n### 4.1. Автоматическое обнаружение и парсинг лотов\n\n*   **Триггер:** `wall_post_new` от VK Callback API, асинхронно обрабатывается `handleWallPostNew()`.\n*   **Критерии:** Пост должен содержать хэштег `#аукцион` (регистр не важен, может быть частью другого хэштега, например, `#аукцион@yourgroup`).\n*   **Парсинг:** Функция `parseLotFromPost()` (`Code.gs`) использует регулярные выражения для извлечения `lot_id`, `name`, `start_price`, `bid_step` и `deadline` из текста поста. Если данные отсутствуют, используются значения по умолчанию.\n*   **Запись:** Новый лот записывается в лист \"Лоты\" (`Config`) со статусом `active`.\n*   **Мониторинг:** События `LOT_CREATED` и `LOT_PARSE_FAILED` логируются в лист \"Статистика\".\n\n### 4.2. Обработка и валидация ставок\n\n*   **Триггер:** `wall_reply_new` от VK Callback API, асинхронно обрабатывается `handleWallReplyNew()`.\n*   **Парсинг ставки:** Функция `parseBid()` (`Code.gs`) извлекает числовое значение ставки из текста комментария.\n*   **`LockService`:** `handleWallReplyNew()` использует `LockService` для атомарной обработки ставок, предотвращая `race conditions` и гарантируя корректное определение лидера.\n*   **Валидация:** Функция `validateBid()` (`Code.gs`) выполняет следующие проверки (в порядке приоритета):\n    1.  **Дедлайн:** Аукцион не должен быть завершен (`new Date() < lot.deadline`).\n    2.  **Максимальная ставка:** Ставка не должна превышать `settings.max_bid` (настраивается в листе \"Настройки\").\n    3.  **Минимальная ставка:** Ставка должна быть строго больше `current_price` (или `start_price`, если ставок еще не было).\n    4.  **Шаг ставки:** Ставка должна быть кратна `lot.bid_step` (если `bid_step_enabled` включен в настройках).\n*   **Запись:** Валидная ставка записывается в лист \"Ставки\" (`Bids`).\n*   **Обновление лота:** `current_price` и `leader_id` лота в листе \"Лоты\" (`Config`) обновляются.\n*   **Продление аукциона (`Anti-Sniper`):** Если валидная ставка сделана в последние `10` минут до дедлайна, аукцион автоматически продлевается на `10` минут. Это предотвращает \"снайперские\" ставки в последний момент.\n*   **Мониторинг:** События `BID_RECEIVED`, `BID_VALIDATED`, `BID_RECORDED`, `LEADER_UPDATED`, `AUCTION_EXTENDED` логируются в лист \"Статистика\".\n\n### 4.3. Система уведомлений\n\n*   **Триггер:** `processNotificationQueue()` запускается каждую минуту по таймеру.\n*   **Очередь:** Все исходящие уведомления ставятся в лист \"Очередь\" (`NotificationQueue`).\n*   **Типы уведомлений:**\n    *   `outbid`: Отправляется предыдущему лидеру, когда его ставка перебита.\n    *   `low_bid`: Отправляется участнику, чья ставка оказалась ниже текущей цены (с дружелюбным текстом).\n    *   `winner`: Отправляется победителю после финализации аукциона.\n*   **Rate Limiting:** `processNotificationQueue()` использует `Utilities.sleep(350);` для соблюдения лимита VK API в 3 запроса/сек, отправляя уведомления с небольшой задержкой.\n*   **Дебонс:** `queueNotification()` проверяет наличие уже `pending` уведомления для данного `user_id` и `type` и обновляет его `payload`, предотвращая спам идентичными уведомлениями.\n*   **Мониторинг:** События `OUTBID_NOTIFICATION_QUEUED`, `LOW_BID_NOTIFICATION_QUEUED` логируются в лист \"Статистика\".\n\n### 4.4. Завершение аукциона и определение победителей\n\n*   **Триггер:** `finalizeAuction()` запускается еженедельно (по умолчанию: суббота в 21:00) по таймеру.\n*   **Алгоритм:**\n    1.  Получает все активные лоты из листа \"Лоты\" (`Config`).\n    2.  Для каждого лота определяет победителя, анализируя лист \"Ставки\" (`Bids`). При равных ставках побеждает самая ранняя.\n    3.  Если победитель найден: лот помечается как `sold`, данные победителя записываются в лист \"Победители\" (`Winners`), отправляется уведомление `winner` и публикуется комментарий под постом.\n    4.  Если ставок не было: лот помечается как `unsold`, публикуется соответствующий комментарий.\n*   **Мониторинг:** События `AUCTION_FINALIZATION_STARTED`, `WINNER_DECLARED`, `LOT_UNSOLD` логируются в лист \"Статистика\".\n\n### 4.5. Обработка команды «АУКЦИОН» в ЛС\n\n*   **Триггер:** `message_new` от VK Callback API, асинхронно обрабатывается `handleMessageNew()`.\n*   **Функционал:** Если пользователь отправляет боту сообщение с текстом `АУКЦИОН`, бот формирует сводку по всем выигранным им лотам, рассчитывает стоимость доставки (согласно `delivery_rules` из \"Настроек\") и отправляет сообщение с деталями заказа и реквизитами для оплаты.\n\n### 4.6. Управление через Google Таблицы (UI)\n\n*   **Меню «VK Auction»:** Кастомное меню в Google Таблице предоставляет администраторам удобный доступ к функциям управления:\n    *   `🚀 Мастер настройки`: Инициализация всех листов, заполнение настроек по умолчанию, установка базовых триггеров.\n    *   `🔐 Настройки авторизации`: Безопасное хранение и обновление чувствительных данных (`VK_TOKEN`, `GROUP_ID`, `ADMIN_PASSWORD` и т.д.) через модальное окно.\n    *   `📖 Открыть инструкцию`: Интерактивный сайдбар с подробным руководством.\n    *   `🛠️ Вид таблицы`: Подменю для скрытия/показа системных листов (`Bids`, `EventQueue`, `NotificationQueue`, `Logs`, `Statistics`).\n    *   `⚠️ Ручное управление`: Подменю для принудительного запуска `finalizeAuction`, `processNotificationQueue`, а также сброса/установки триггеров.\n    *   **`🤖 СИМУЛЯТОР`**: Подменю для управления встроенным симулятором аукциона.\n\n### 4.7. Симулятор аукциона (`AuctionSimulator.gs`)\n\n*   **Цель:** Генерация реалистичных тестовых постов-лотов и комментариев-ставок в тестовую группу VK для всесторонней проверки работы бота.\n*   **Функции:**\n    *   `runSingleSimulation()`: Создает один пост-лот по подробному шаблону и генерирует серию комментариев (ставок) под ним.\n    *   `setupHourlySimulation()`: Устанавливает ежечасный триггер для автоматического запуска `runSingleSimulation()` (с лимитом на количество постов).\n    *   `stopSimulation()`: Останавливает ежечасный триггер.\n    *   `resetSimulationCounter()`: Сбрасывает счетчик постов для ежечасной симуляции.\n*   **Сценарии ставок:** Симулятор генерирует различные сценарии ставок:\n    *   **`VALID_BID`:** Валидная ставка, превышающая текущую на шаг.\n    *   **`HIGH_FREQUENCY`:** Несколько быстрых ставок, имитирующих интенсивные торги.\n    *   **`SAME_BID`:** Ставка, равная текущей (должна быть отклонена).\n    *   **`LOWER_BID`:** Ставка ниже текущей (должна быть отклонена с уведомлением `low_bid`).\n    *   **`INVALID_STEP`:** Ставка, не кратная установленному шагу (должна быть отклонена).\n*   **Многопользовательская симуляция:** Использует массив `SIMULATOR_SETTINGS.testUsers` для имитации ставок от разных `user_id`, что позволяет проверять логику `outbid` уведомлений.\n*   **Логирование:** Все действия симулятора подробно логируются в лист \"Статистика\".\n\n---\n\n## 5. ВОЗМОЖНЫЕ ОШИБКИ И СЛОЖНОСТИ (ПРОБЛЕМЫ И РЕШЕНИЯ)\n\n### 5.1. VK Callback API Timeout (5 секунд)\n\n*   **Проблема:** VK ожидает HTTP 200 `\"ok\"` в течение 5 секунд. При превышении таймаута VK может повторить отправку события, что чревато дублированием и нестабильностью.\n*   **Решение:** `doPost()` (`Code.gs`) не выполняет сложную логику. Оно мгновенно сохраняет сырой JSON события в лист \"Очередь Событий\" (`EventQueue`) и сразу возвращает `\"ok\"`. Фактическая обработка события вынесена в `processEventQueue()`, которая запускается по отдельному триггеру каждую минуту.\n\n### 5.2. Google Apps Script Quotas\n\n*   **Проблема:** GAS имеет квоты на количество вызовов `UrlFetchApp` (20,000/день), общее время выполнения скриптов (90 мин/день), одновременные выполнения `doPost` (30) и т.д. Превышение квот приводит к остановке скриптов.\n*   **Решение:** Архитектура с асинхронными очередями (`EventQueue`, `NotificationQueue`) и `LockService` позволяет эффективно распределять нагрузку и выполнять операции в рамках квот. Проект рассчитан на заявленную нагрузку с большим запасом.\n\n### 5.3. VK API Rate Limiting (3 запроса/сек)\n\n*   **Проблема:** VK API ограничивает количество запросов в секунду (3 req/sec для большинства методов). Превышение лимита приводит к ошибке 429 `Too Many Requests`.\n*   **Решение:** Исходящие уведомления и комментарии отправляются через `NotificationQueue` (`Code.gs`, `processNotificationQueue()`). Эта функция намеренно использует `Utilities.sleep(350);` между запросами, обеспечивая безопасную частоту ≈2.85 запроса/сек. В `callVk` предусмотрена базовая обработка ошибок, но явной логики `retry` с `exponential backoff` сейчас нет (потенциальное улучшение).\n\n### 5.4. Race Conditions (Состояния гонки)\n\n*   **Проблема:** Если два пользователя делают ставку на один лот практически одновременно, без механизмов синхронизации обе ставки могут быть приняты как максимальные, что приведет к некорректному определению победителя.\n*   **Решение:** `handleWallReplyNew()` (`Code.gs`) использует `LockService.getScriptLock().waitLock(5000);`. Это гарантирует, что только один экземпляр функции может модифицировать данные конкретного лота в любой момент времени. Данные лота перечитываются внутри заблокированного блока для обеспечения актуальности.\n\n### 5.5. Некорректный парсинг постов/ставок\n\n*   **Проблема:** Невнимательность администратора при создании поста или участника при ставке может привести к тому, что бот не сможет правильно извлечь `lot_id`, `start_price`, `deadline` или сумму ставки.\n*   **Решение:** Функции `parseLotFromPost()` и `parseBid()` используют гибкие регулярные выражения. Предусмотрены `fallback` значения по умолчанию. События `LOT_PARSE_FAILED` и нераспознанные комментарии логируются в лист \"Статистика\" и \"Журнал\" для последующего анализа. **Симулятор генерирует сложные тестовые посты и ставки для проверки надежности парсинга.**\n\n### 5.6. Использование токенов и безопасность\n\n*   **Проблема:** Хранение чувствительных `VK_TOKEN` и `VK_SECRET` напрямую в коде или в публичных листах таблиц небезопасно.\n*   **Решение:** Все чувствительные данные хранятся в `PropertiesService` Google Apps Script, который обеспечивает безопасное хранение, доступное только скрипту. Настройка этих параметров осуществляется через UI в Google Таблицах (`VK Auction -> Настройка авторизации (VK)`), исключая прямой контакт с кодом.\n\n### 5.7. Продление аукциона и \"снайперские\" ставки\n\n*   **Проблема:** Участники могут делать ставки в последние секунды аукциона (`снайперские` ставки), что снижает интерактивность и может быть несправедливо.\n*   **Решение:** Реализован механизм продления аукциона: если валидная ставка сделана в последние `10` минут до дедлайна, аукцион автоматически продлевается на `10` минут. Это дает другим участникам шанс ответить.\n\n### 5.8. Отсутствие логики `retry` с `exponential backoff` для `callVk`\n\n*   **Проблема:** В текущей реализации `callVk` (`VkApi.gs`) при ошибке VK API (например, 429 `Too Many Requests` или сетевой сбой) запрос не повторяется с нарастающей задержкой. `muteHttpExceptions: true` позволяет обработать ошибку, но не гарантирует доставку.\n*   **Решение (потенциальное улучшение):** Добавление полноценной логики `retry` с `exponential backoff` (например, 1 сек, 2 сек, 4 сек) внутри `callVk` повысит надежность отправки отдельных запросов. Однако для массовых уведомлений эта проблема митигируется очередью `NotificationQueue`.\n\n### 5.9. Отсутствие обработки `wall_reply_edit` / `wall_reply_delete`\n\n*   **Проблема:** Изменение или удаление комментария со ставкой не приводит к пересчету ставок или удалению записи из листа \"Ставки\".\n*   **Решение (потенциальное улучшение):** Реализация обработчиков для этих событий VK Callback API, которые будут обновлять статус соответствующей ставки в листе \"Ставки\" (например, `status = 'deleted'`) или инициировать пересчет лидера лота. Текущая система фиксирует ставку на момент ее поступления.\n\n### 5.10. Один `testUserId` в симуляторе\n\n*   **Проблема:** Изначально симулятор использовал один `testUserId` для всех ставок, что не позволяло полноценно тестировать уведомления `outbid` для разных пользователей.\n*   **Решение:** `AuctionSimulator.gs` был обновлен для использования массива `SIMULATOR_SETTINGS.testUsers`, и теперь случайный тестовый пользователь выбирается для каждой ставки, что улучшает реалистичность симуляции и покрытие тестами.\n\n---\n\n## 6. МАСШТАБИРУЕМОСТЬ И ПРОИЗВОДИТЕЛЬНОСТЬ\n\n### 6.1. Google Apps Script Quotas (АКТУАЛЬНО)\n\n| Лимит                                | Значение      | Наша нагрузка (прогноз)                     | Статус |\
| :----------------------------------- | :------------ | :------------------------------------------ | :----- |\
| **`UrlFetch calls/день`**            | 20,000        | ~500/день (4 аукциона + симулятор)          | ✅ 2.5% |\
| **`Script runtime (одно выполнение)`** | 6 минут       | < 10 сек (`doPost`), < 60 сек (`processEventQueue`/`NotificationQueue`) | ✅ 1-10% |\
| **`doPost concurrent`**              | 30            | < 10 одновременно (пик)                     | ✅ 33% |\
| **`Total runtime/день`**             | 90 минут      | ~10 минут/день (с учетом симулятора)        | ✅ 11% |\
| **`Triggers total`**                 | 20            | 4 (EventQueue, NotificationQueue, finalizeAuction, runSingleSimulation) | ✅ 20% |\
| **`Spreadsheet read/write`**         | Без явного лимита | ~1000/день (с учетом симулятора)            | ✅ OK |\
\n**Вывод:** Все лимиты соблюдены с большим запасом. Система легко масштабируется до ~1000 ставок в день без достижения квот. Для существенного увеличения нагрузки потребуется оптимизация запросов к таблицам (например, кеширование `getSheetData`).\n\n### 6.2. Производительность (АКТУАЛЬНО)\n\n| Метрика               | Требование        | Обоснование                                                  |\
| :-------------------- | :---------------- | :----------------------------------------------------------- |\
| **Ответ VK Callback** | < 2 секунды       | VK лимит 5 сек, запас ×2.5 за счет асинхронной очереди `EventQueue` |\
| **Обработка ставки**  | < 1.5 секунды     | `LockService` + запись в Sheets (`EventQueue` -> `handleWallReplyNew`) |\
| **Задержка уведомления** | 1-3 минуты      | Асинхронная очередь `NotificationQueue`, обработка каждую минуту, дебонс |\
| **Завершение аукциона** | < 5 минут на 15 лотов | Определение победителей + уведомления.                     |\
| **VK API Rate Limit** | ≤ 2.85 запроса/секунду | VK лимит 3/сек, безопасный запас при отправке уведомлений.   |\
| **Concurrent ставок** | До 30 одновременно | GAS лимит 30 `doPost` concurrent.                            |\
\n---\n\n## 7. БЕЗОПАСНОСТЬ\n\n### 7.1. Хранение чувствительных данных\n\n*   **`PropertiesService`:** `VK_TOKEN`, `VK_SECRET`, `ADMIN_PASSWORD` хранятся здесь. Это рекомендуемый способ Google для хранения конфиденциальных данных в Apps Script, они недоступны напрямую из кода или логов.\n*   **Google Sheets:** В таблицах не хранятся персональные данные (`ФИО`, `телефоны`, `адреса`) участников. Хранятся только `user_id` VK, `bid_amount`, `timestamp` и `comment_id`, что соответствует минимальным требованиям для работы аукциона.\n*   **`ADMIN_PASSWORD`:** Используется для защиты доступа к `Настройкам авторизации`. После 5 неудачных попыток доступа блокируется на 6 часов.\n\n### 7.2. Соответствие ФЗ-152 (частичное)\n\nСистема стремится минимизировать сбор и хранение персональных данных. `user_id` считается техническим идентификатором, а не персональными данными, пока не связывается с ФИО. ФИО пользователей запрашиваются из VK API динамически только для формирования отчетов и не сохраняются в таблицах.\n\n**Рекомендуемая Политика конфиденциальности (для сообщества):**\n```\nПри участии в аукционе обрабатываются: технический ID VK, суммы ставок, timestamp.\\nНЕ храним: ФИО, телефоны, email, адреса на серверах.\\nОснование: исполнение договора (ч. 5 ст. 6 ФЗ-152).\\nУдаление данных: написать \\\"УДАЛИТЬ МОИ ДАННЫЕ\\\" в ЛС (обработка в течение 3 дней, удаляются записи из листов \\\"Ставки\\\" и \\\"Победители\\\").\n```\n\n---\n\n## 8. РАЗВЕРТЫВАНИЕ И ОБСЛУЖИВАНИЕ\n\n### 8.1. Чеклист развертывания (АКТУАЛЬНО)\n\n1.  **Создание Google Таблицы и проекта Apps Script:**\n    *   Создать новую Google Таблицу.\n    *   Перейти в меню **Расширения** → **Apps Script**.\n    *   Скопировать содержимое следующих файлов в соответствующие файлы скрипта:\n        *   `Code.gs`, `Sheets.gs`, `VkApi.gs`, `Monitoring.gs`, `AuctionSimulator.gs`, `appsscript.json`.\n    *   В Google Sheets открыть меню **VK Auction** -> **Мастер настройки** для создания всех необходимых листов и установки начальных настроек.\n2.  **Настройка VK Callback API:**\n    *   Перейти в настройки вашего сообщества ВКонтакте.\n    *   Выбрать раздел **Работа с API** → **Callback API**.\n    *   Создать новый Callback API сервер.\n    *   **URL сервера:** Скопировать URL из Apps Script после публикации (см. п.3.4). Например: `https://script.google.com/macros/s/.../exec`.\n    *   **Версия API:** 5.131 (или выше).\n    *   Включить следующие типы событий: `wall_post_new`, `wall_reply_new`, `message_new`.\n    *   Сохранить **Secret key** и **Confirmation string**.\n3.  **Публикация веб-приложения (Deploy Web App):**\n    *   В редакторе Apps Script нажать **Deploy** → **New deployment**.\n    *   Выбрать тип: **Web app**.\n    *   Настройки: `Execute as: Me`, `Who has access: Anyone`.\n    *   Скопировать URL веб-приложения и использовать его в настройках Callback API.\n4.  **Первоначальная настройка бота:**\n    *   В Google Sheets открыть меню **VK Auction**.\n    *   Выбрать **Настройка авторизации (VK)**.\n    *   Ввести необходимые параметры: `VK_TOKEN`, `GROUP_ID`, `CONFIRMATION_CODE`, `VK_SECRET`, `PAYMENT_PHONE`, `PAYMENT_BANK`, `ADMIN_PASSWORD` (по желанию). Эти данные сохраняются в `PropertiesService`.\n    *   В листе **Настройки** (`Settings`) заполнить общие параметры (`max_bid`, `bid_step`, `delivery_rules` и т.д.).\n5.  **Проверка и активация триггеров:**\n    *   Убедиться, что активны следующие триггеры (через **Расширения** → **Apps Script** → **Триггеры**):\n        *   `processEventQueue()` — Time-based, Every minute.\n        *   `processNotificationQueue()` — Time-based, Every minute.\n        *   `finalizeAuction()` — Time-based, Every week Saturday 21:00.\n        *   `runSingleSimulation()` — Time-based, Every hour (если включена ежечасная симуляция через меню).\n\n### 8.2. Тестирование с симулятором\n\n1.  Используйте меню **VK Auction → СИМУЛЯТОР → Запустить один цикл симуляции**.\n2.  Проверьте в VK, что опубликован тестовый пост-лот.\n3.  Наблюдайте за комментариями под постом (имитация ставок) и за получением ЛС от бота.\n4.  Проверьте листы **\"Лоты\"**, **\"Ставки\"**, **\"Очередь\"**, **\"Статистика\"** на корректность записи данных и постановки уведомлений в очередь.\n5.  Запустите `finalizeAuction()` вручную через меню **VK Auction → Ручное управление → Завершить аукцион**.\n6.  Проверьте листы **\"Победители\"** и комментарии под постами на корректность определения победителя.\n\n### 8.3. Обслуживание и отладка\n\n*   **Мониторинг логов:** Регулярно проверяйте лист **\"Журнал\" (`Logs`)** и встроенный логгер Apps Script (Logs в редакторе скриптов) на предмет ошибок и предупреждений.\n*   **Лист \"Статистика\":** Анализируйте записи в этом листе для понимания общего поведения системы и выявления аномалий.\n*   **Симулятор:** Используйте `AuctionSimulator.gs` для воспроизведения специфических сценариев или быстрой проверки изменений.\n*   **Проверка соединения:** Меню **VK Auction -> Проверить соединение** для диагностики проблем с VK API.\n\n---\n\n## 9. ДАЛЬНЕЙШЕЕ РАЗВИТИЕ (ПОТЕНЦИАЛЬНЫЕ УЛУЧШЕНИЯ)\n\n| Функция                   | Описание                                                                  | Сложность    | Оценка времени |\
| :------------------------ | :------------------------------------------------------------------------ | :----------- | :------------- |\
| **Автонапоминания**       | Через N дней после аукциона бот пишет не оформившим заказ.                 | Средняя      | +4 часа        |\
| **Расширенная статистика** | Лист с графиками: популярные лоты, средний чек, конверсия. Интеграция с Google Data Studio. | Средняя      | +10 часов      |\
| **Множественные группы**  | Поддержка нескольких групп в одной таблице (сложная модификация логики работы с листами). | Высокая      | +20 часов      |\
| **CRM интеграция**        | Выгрузка победителей в Битрикс24/amoCRM (через API).                      | Высокая      | +15 часов      |\
| **Веб-админка**           | Красивая панель управления вместо Sheets (с использованием GAS Web App + HTML/CSS/JS). | Очень высокая | +40 часов      |\
| **Онлайн-эквайринг**      | Интеграция с платежными системами (ЮKassa/Robokassa).                    | Очень высокая | +30 часов      |\
| **Проверка подписки**     | Отклонение ставок от пользователей, не являющихся подписчиками группы.     | Низкая       | +2 часа        |\
| **Редактирование/удаление ставок** | Обработка `wall_reply_edit` / `wall_reply_delete` для изменения или отмены ставок в листе \"Ставки\". | Средняя      | +8 часов       |\
| **Улучшенная обработка ошибок `callVk`** | Добавление `retry` с `exponential backoff` для повышения надежности запросов к VK API. | Средняя      | +4 часа        |\
\n---\n\n## 10. ФАЙЛЫ ПРОЕКТА\n\n```\nproject/\n├── Code.gs              # Основная логика бота: `doPost()`, обработчики событий, `finalizeAuction()`, функции UI.\n├── Sheets.gs            # Библиотека для работы с Google Sheets: конфигурация листов, `getSheet()`, `appendRow()`, `updateRow()`, логирование в `Журнал`.\n├── VkApi.gs             # Оболочка для взаимодействия с VK API: `callVk()` с обработкой токенов и ошибок.\n├── Monitoring.gs        # Независимый модуль для логирования ключевых событий системы в лист `Статистика`.\n├── AuctionSimulator.gs  # Модуль симулятора аукциона: генерация тестовых постов и ставок в VK.\n├── appsscript.json      # Манифест проекта Google Apps Script (определяет разрешения, триггеры, HTML-файлы).\n├── AuthSettings.html    # HTML-файл для UI настройки авторизации.\n├── Instructions.html    # HTML-файл для UI отображения инструкции.\n├── Login.html           # HTML-файл для UI входа с паролем администратора.\n├── CHANGELOG.md         # Журнал изменений проекта.\n├── README.md            # Краткое описание проекта и инструкции по установке.\n├── vk-auction-tech-spec-v2.md # Техническая спецификация проекта (более краткая версия).\n└── FULL_PROJECT_SPEC.md # Полная техническая спецификация проекта (данный документ).\n```\n\n---\n\n**Конец полной технической спецификации**\n\n_Версия 2.2 от 10.02.2026_\n_Охватывает: Архитектуру, модульность, асинхронную обработку, `LockService`, `Rate Limiting`, `max_bid`, продление аукциона, полный журнал ставок, уведомления о низких ставках, `AuctionSimulator`, лучшие практики, возможные сложности и дальнейшее развитие._