# ПОЛНАЯ ТЕХНИЧЕСКАЯ СПЕЦИФИКАЦИЯ (Версия 3.1)
**Проект:** VK Auction Bot
**Дата:** 21.02.2026

---

## 1. АРХИТЕКТУРА СИСТЕМЫ

### 1.1. Основные компоненты
Система построена на базе Google Apps Script и взаимодействует с VK Callback API.

*   **doPost(e)**: Точка входа. Обрабатывает события мгновенно.
*   **routeEvent(payload)**: Маршрутизатор. Направляет события в нужные обработчики.
*   **handleWallReplyNew**: Ядро обработки ставок. Использует `LockService` и `CacheService`.
*   **handleWallPostNew**: Автоматическое создание лотов по тегу.
*   **finalizeAuction**: Подведение итогов, определение победителей.
*   **PeriodicTasks**: Управление триггерами и ежедневное обслуживание.

### 1.2. База данных (Google Sheets)
*   **Config (Лоты)**: Основной реестр. Ключ — `post_id`.
*   **Bids (Ставки)**: Журнал всех попыток ставок. Умная запись по именам столбцов.
*   **Users (Пользователи)**: Профили покупателей и статусы накопления.
*   **Orders (Заказы)**: Учет выигранных лотов.
*   **Settings (Настройки)**: Конфигурация поведения бота.
*   **Logs / Incoming**: Мониторинг и отладка (новые записи сверху).

---

## 2. КЛЮЧЕВАЯ ЛОГИКА

### 2.1. Обработка ставок (Atomic Transaction)
1.  **Idempotency**: Проверка `CacheService` (10 мин) и `isBidExists` в таблице.
2.  **Locking**: `LockService` на 5 секунд для предотвращения race conditions.
3.  **Validation**:
    *   Проверка дедлайна (по МСК).
    *   Проверка минимальной суммы (`Текущая + Шаг`).
    *   Проверка кратности шагу.
4.  **Recording**: Сначала запись в "Ставки", затем обновление "Лотов".
5.  **Notification**: Ответ в комментарии только при перебитии или ошибке.

### 2.2. Финализация
*   Запускается автоматически через `periodicSystemCheck`.
*   Сначала меняет статус лота на "Продан", затем рассылает уведомления.
*   Администраторы получают полный отчет в ЛС.

---

## 3. ИНТЕГРАЦИЯ VK

*   **Токен**: Используется преимущественно токен группы.
*   **Методы**:
    *   `wall.createComment`: Ответы в ветках.
    *   `messages.send`: Уведомления победителям и отчеты админам.
    *   `users.get`: Получение имен для отчетов.
*   **Защита**: Отказ от `wall.getComments` для работы без админ-прав.

---

## 4. ГАРАНТИИ НАДЕЖНОСТИ
*   **Защита от смещения**: Запись в таблицу по именам заголовков.
*   **Защита от петель**: Авто-удаление триггеров при отсутствии активных задач.
*   **Защита от вылетов**: Принудительное строковое приведение всех данных в логах.

---
*Документация актуальна для версии 3.1.0*
